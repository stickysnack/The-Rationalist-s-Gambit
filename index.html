<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>理性人的试炼 - The Rationalist's Trial</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Press Start 2P', monospace;
            background: linear-gradient(135deg, #0d1117, #161b22, #21262d);
            color: #f0f6fc;
            overflow: hidden;
            user-select: none;
            cursor: default;
        }
        
        .game-container {
            width: 100vw;
            height: 100vh;
            position: relative;
            display: flex;
            flex-direction: column;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 215, 0, 0.1) 0%, transparent 50%);
        }
        
        /* 扫描线效果 */
        .scanlines {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(255, 255, 255, 0.03) 2px,
                rgba(255, 255, 255, 0.03) 4px
            );
            pointer-events: none;
            z-index: 1000;
        }
        
        /* 开始界面 */
        .start-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #0d1117, #21262d);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            transition: opacity 0.8s ease;
            overflow: hidden;
        }
        
        .start-screen::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 30% 20%, rgba(255, 215, 0, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 70% 80%, rgba(74, 159, 255, 0.08) 0%, transparent 50%);
            animation: backgroundShift 8s ease-in-out infinite alternate;
        }
        
        @keyframes backgroundShift {
            0% { 
                background: 
                    radial-gradient(circle at 30% 20%, rgba(255, 215, 0, 0.1) 0%, transparent 50%),
                    radial-gradient(circle at 70% 80%, rgba(74, 159, 255, 0.08) 0%, transparent 50%);
            }
            100% { 
                background: 
                    radial-gradient(circle at 70% 30%, rgba(255, 215, 0, 0.15) 0%, transparent 60%),
                    radial-gradient(circle at 30% 70%, rgba(74, 159, 255, 0.12) 0%, transparent 60%);
            }
        }
        
        .title-logo {
            font-size: 28px;
            color: #ffd700;
            text-shadow: 
                0 0 10px rgba(255, 215, 0, 0.6),
                0 0 20px rgba(255, 215, 0, 0.4),
                0 0 40px rgba(255, 215, 0, 0.2);
            margin-bottom: 20px;
            animation: titleGlow 3s ease-in-out infinite alternate;
            position: relative;
            z-index: 1;
        }
        
        .subtitle {
            font-size: 12px;
            color: #7d8590;
            margin-bottom: 40px;
            letter-spacing: 2px;
            position: relative;
            z-index: 1;
            animation: subtitleFade 2s ease-in-out infinite alternate;
        }

        /* 初始金额设置面板 */
        .settings-panel {
            background: linear-gradient(145deg, #21262d, #161b22);
            border: 2px solid #ffd700;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 40px;
            position: relative;
            z-index: 1;
        }

        .settings-title {
            color: #ffd700;
            font-size: 10px;
            margin-bottom: 15px;
            text-align: center;
        }

        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .setting-label {
            font-size: 8px;
            color: #c9d1d9;
        }

        .setting-input {
            background: #0d1117;
            border: 1px solid #30363d;
            color: #ffd700;
            padding: 5px 8px;
            font-family: 'Press Start 2P', monospace;
            font-size: 8px;
            width: 80px;
            text-align: center;
            border-radius: 4px;
        }

        .setting-input:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }
        
        @keyframes titleGlow {
            from { 
                text-shadow: 
                    0 0 10px rgba(255, 215, 0, 0.6),
                    0 0 20px rgba(255, 215, 0, 0.4),
                    0 0 40px rgba(255, 215, 0, 0.2);
                transform: scale(1);
            }
            to { 
                text-shadow: 
                    0 0 15px rgba(255, 215, 0, 0.8),
                    0 0 30px rgba(255, 215, 0, 0.6),
                    0 0 60px rgba(255, 215, 0, 0.3);
                transform: scale(1.02);
            }
        }
        
        @keyframes subtitleFade {
            from { opacity: 0.6; }
            to { opacity: 1; }
        }
        
        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }
        
        .pixel-btn {
            font-family: 'Press Start 2P', monospace;
            font-size: 10px;
            padding: 15px 30px;
            background: linear-gradient(145deg, #21262d, #161b22);
            color: #ffd700;
            border: 2px solid #30363d;
            position: relative;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-transform: uppercase;
            letter-spacing: 1px;
            min-width: 200px;
            text-align: center;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .pixel-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.3), transparent);
            transition: left 0.6s ease;
        }
        
        .pixel-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.4), transparent);
            border-radius: 50%;
            transition: all 0.4s ease;
            transform: translate(-50%, -50%);
        }
        
        .pixel-btn:hover::before {
            left: 100%;
        }
        
        .pixel-btn:hover::after {
            width: 100%;
            height: 100%;
        }
        
        .pixel-btn:hover {
            transform: translateY(-3px) scale(1.02);
            border-color: #ffd700;
            background: linear-gradient(145deg, #2a2f3a, #1e2328);
            box-shadow: 
                0 8px 25px rgba(0, 0, 0, 0.4),
                0 0 20px rgba(255, 215, 0, 0.2),
                inset 0 0 0 1px rgba(255, 215, 0, 0.4);
            color: #fff;
        }
        
        .pixel-btn:active {
            transform: translateY(-1px) scale(0.98);
            transition: all 0.1s ease;
        }
        
        /* 教程面板 */
        .tutorial-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .tutorial-panel.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .tutorial-content {
            background: linear-gradient(145deg, #21262d, #161b22);
            border: 2px solid #ffd700;
            border-radius: 10px;
            padding: 30px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        
        .tutorial-step {
            margin-bottom: 30px;
            animation: fadeInUp 0.6s ease forwards;
            opacity: 0;
            transform: translateY(20px);
        }
        
        .tutorial-step:nth-child(1) { animation-delay: 0.1s; }
        .tutorial-step:nth-child(2) { animation-delay: 0.2s; }
        .tutorial-step:nth-child(3) { animation-delay: 0.3s; }
        .tutorial-step:nth-child(4) { animation-delay: 0.4s; }
        .tutorial-step:nth-child(5) { animation-delay: 0.5s; }
        .tutorial-step:nth-child(6) { animation-delay: 0.6s; }
        .tutorial-step:nth-child(7) { animation-delay: 0.7s; }
        .tutorial-step:nth-child(8) { animation-delay: 0.8s; }
        
        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .tutorial-title {
            font-size: 14px;
            color: #ffd700;
            margin-bottom: 15px;
        }
        
        .tutorial-text {
            font-size: 8px;
            line-height: 1.6;
            color: #c9d1d9;
            margin-bottom: 10px;
        }
        
        .tutorial-highlight {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.3);
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }

        /* 成就面板样式 */
        .achievement-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .achievement-panel.active {
            opacity: 1;
            pointer-events: all;
        }

        .achievement-content {
            background: linear-gradient(145deg, #21262d, #161b22);
            border: 2px solid #ffd700;
            border-radius: 15px;
            padding: 30px;
            max-width: 90vw;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .achievement-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .achievement-item {
            background: linear-gradient(145deg, #2a2f3a, #1e2328);
            border: 2px solid #30363d;
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .achievement-item.unlocked {
            border-color: #ffd700;
            background: linear-gradient(145deg, #3a3520, #2d2a15);
        }

        .achievement-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(255, 215, 0, 0.3);
        }

        .achievement-item-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .achievement-item-icon {
            font-size: 20px;
            margin-right: 10px;
            filter: grayscale(1);
            opacity: 0.5;
            transition: all 0.3s ease;
        }

        .achievement-item.unlocked .achievement-item-icon {
            filter: grayscale(0);
            opacity: 1;
        }

        .achievement-item-name {
            font-size: 10px;
            color: #7d8590;
            transition: color 0.3s ease;
        }

        .achievement-item.unlocked .achievement-item-name {
            color: #ffd700;
        }

        .achievement-item-desc {
            font-size: 8px;
            color: #c9d1d9;
            margin: 8px 0;
            line-height: 1.4;
        }

        .achievement-item-quote {
            font-size: 7px;
            color: #7d8590;
            font-style: italic;
            line-height: 1.3;
            border-left: 2px solid #30363d;
            padding-left: 8px;
            margin-top: 10px;
            transition: all 0.3s ease;
        }

        .achievement-item.unlocked .achievement-item-quote {
            color: #c9d1d9;
            border-left-color: #ffd700;
        }

        /* 成就通知样式 */
        .achievement-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(145deg, #ffd700, #d4af37);
            border: 3px solid #fff;
            border-radius: 15px;
            padding: 20px;
            color: #0d1117;
            font-family: 'Press Start 2P', monospace;
            font-size: 10px;
            max-width: 350px;
            z-index: 6000;
            box-shadow: 
                0 10px 30px rgba(255, 215, 0, 0.5),
                0 0 20px rgba(255, 215, 0, 0.3);
            animation: achievementSlideIn 1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform: translateX(100%);
        }

        .achievement-notification.show {
            transform: translateX(0);
        }

        .achievement-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .achievement-icon {
            font-size: 24px;
            margin-right: 10px;
            animation: achievementBounce 2s ease-in-out infinite;
        }

        .achievement-title {
            font-size: 8px;
            color: #8B4513;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .achievement-name {
            font-size: 12px;
            color: #0d1117;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .achievement-quote {
            font-size: 7px;
            color: #654321;
            line-height: 1.4;
            font-style: italic;
            border-left: 3px solid rgba(13, 17, 23, 0.3);
            padding-left: 10px;
            margin-top: 10px;
        }

        @keyframes achievementSlideIn {
            0% {
                transform: translateX(100%) scale(0.8);
                opacity: 0;
            }
            70% {
                transform: translateX(-20px) scale(1.05);
                opacity: 1;
            }
            100% {
                transform: translateX(0) scale(1);
                opacity: 1;
            }
        }

        @keyframes achievementBounce {
            0%, 100% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.1) rotate(-5deg); }
            50% { transform: scale(1) rotate(0deg); }
            75% { transform: scale(1.1) rotate(5deg); }
        }
        
        /* 故事对话面板 */
        .story-dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: storyFadeIn 1s ease;
        }
        
        .story-dialog {
            max-width: 700px;
            background: linear-gradient(145deg, #21262d, #161b22);
            border: 3px solid #ffd700;
            border-radius: 15px;
            padding: 30px;
            color: #f0f6fc;
            font-family: 'Press Start 2P', monospace;
            text-align: center;
            box-shadow: 0 20px 60px rgba(255, 215, 0, 0.3);
            animation: storySlideIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }

        .story-dialog::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(from 0deg, transparent, rgba(255, 215, 0, 0.1), transparent);
            animation: rotate 6s linear infinite;
        }

        .story-dialog > * {
            position: relative;
            z-index: 1;
        }
        
        .story-dialog-title {
            font-size: 16px;
            color: #ffd700;
            margin-bottom: 20px;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
        }
        
        .story-dialog-text {
            font-size: 9px;
            line-height: 1.6;
            margin-bottom: 25px;
            color: #c9d1d9;
            text-align: left;
        }
        
        .story-dialog-choices {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .story-choice-btn {
            font-family: 'Press Start 2P', monospace;
            font-size: 8px;
            padding: 12px 20px;
            background: linear-gradient(145deg, #21262d, #161b22);
            color: #ffd700;
            border: 2px solid #30363d;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .story-choice-btn:hover {
            border-color: #ffd700;
            background: linear-gradient(145deg, #2a2f3a, #1e2328);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
            transform: translateY(-2px);
        }

        .special-choice {
            background: linear-gradient(145deg, #8b4513, #654321);
            color: #ffd700;
            border-color: #8b4513;
        }

        .special-choice:hover {
            border-color: #ffd700;
            box-shadow: 0 0 15px rgba(139, 69, 19, 0.5);
        }
        
        @keyframes storyFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes storySlideIn {
            from {
                transform: scale(0.8) translateY(50px);
                opacity: 0;
            }
            to {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }
        
        /* 顶部状态栏 */
        .status-bar {
            height: 90px;
            background: linear-gradient(90deg, #0d1117, #1c2128, #21262d);
            border-bottom: 4px solid #ffd700;
            display: flex;
            align-items: center;
            padding: 0 25px;
            box-shadow: 
                0 6px 30px rgba(255, 215, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1),
                inset 0 -1px 0 rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        .status-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 215, 0, 0.15), 
                rgba(74, 159, 255, 0.1),
                transparent);
            animation: statusSweep 6s infinite ease-in-out;
        }
        
        .status-bar::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, 
                transparent, 
                #ffd700, 
                #4a9eff, 
                #ffd700, 
                transparent);
            animation: statusGlow 3s ease-in-out infinite alternate;
        }
        
        @keyframes statusSweep {
            0%, 100% { left: -100%; }
            50% { left: 100%; }
        }
        
        @keyframes statusGlow {
            from { 
                box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
                opacity: 0.8;
            }
            to { 
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
                opacity: 1;
            }
        }
        
        .status-item {
            margin-right: 35px;
            text-align: center;
            position: relative;
            z-index: 1;
            padding: 10px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .status-item:hover {
            background: rgba(255, 215, 0, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.2);
        }
        
        .status-label {
            font-size: 8px;
            color: #7d8590;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: color 0.3s ease;
        }
        
        .status-value {
            font-size: 14px;
            color: #ffd700;
            text-shadow: 0 0 12px rgba(255, 215, 0, 0.4);
            position: relative;
            transition: all 0.3s ease;
            font-weight: bold;
        }
        
        .status-value.animate {
            animation: valueChange 0.7s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .status-value.critical {
            color: #f85149;
            animation: criticalPulse 1.2s ease-in-out infinite;
        }
        
        @keyframes valueChange {
            0% { transform: scale(1); }
            30% { transform: scale(1.3) rotateY(180deg); color: #fff; }
            70% { transform: scale(0.9) rotateY(360deg); }
            100% { transform: scale(1); }
        }
        
        @keyframes criticalPulse {
            0%, 100% { 
                color: #f85149;
                text-shadow: 
                    0 0 12px rgba(248, 81, 73, 0.6),
                    0 0 25px rgba(248, 81, 73, 0.3);
                transform: scale(1);
            }
            50% { 
                color: #ff6b6b;
                text-shadow: 
                    0 0 18px rgba(248, 81, 73, 0.9),
                    0 0 35px rgba(248, 81, 73, 0.5);
                transform: scale(1.1);
            }
        }
        
        /* 财富条 */
        .wealth-bar {
            position: absolute;
            bottom: -2px;
            left: 5px;
            right: 5px;
            height: 6px;
            background: linear-gradient(90deg, #f85149, #ffd700, #2ea043);
            transition: all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            border-radius: 3px;
            box-shadow: 
                0 0 15px rgba(255, 215, 0, 0.6),
                inset 0 1px 0 rgba(255, 255, 255, 0.3),
                inset 0 -1px 0 rgba(0, 0, 0, 0.2);
            overflow: hidden;
            z-index: 2;
            min-width: 1px; /* 确保即使财富为0也能看到 */
        }
        
        .wealth-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: -50%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.4), 
                transparent);
            animation: wealthShine 2s linear infinite;
        }
        
        @keyframes wealthShine {
            0% { left: -50%; }
            100% { left: 150%; }
        }
        
        /* 主游戏区域 */
        .game-area {
            flex: 1;
            display: flex;
            position: relative;
        }
        
        /* 左侧面板 */
        .left-panel {
            width: 320px;
            background: linear-gradient(145deg, rgba(13, 17, 23, 0.95), rgba(22, 27, 34, 0.95));
            border-right: 2px solid #30363d;
            padding: 20px;
            overflow-y: auto;
            backdrop-filter: blur(10px);
        }
        
        .panel-title {
            color: #ffd700;
            margin-bottom: 20px;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-align: center;
            position: relative;
        }
        
        .panel-title::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 2px;
            background: linear-gradient(90deg, transparent, #ffd700, transparent);
        }
        
        /* 中央拍卖区域 */
        .auction-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        /* 右侧面板 */
        .right-panel {
            width: 300px;
            background: linear-gradient(145deg, rgba(13, 17, 23, 0.95), rgba(22, 27, 34, 0.95));
            border-left: 2px solid #30363d;
            padding: 20px;
            overflow-y: auto;
            backdrop-filter: blur(10px);
        }
        
        /* 增强的卡片样式 */
        .card {
            background: linear-gradient(145deg, #21262d, #161b22);
            border: 2px solid #30363d;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 
                0 4px 20px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.1),
                inset 0 -1px 0 rgba(0, 0, 0, 0.2);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--rarity-color, #7d8590);
            box-shadow: 0 0 15px var(--rarity-color, #7d8590);
            transition: all 0.3s ease;
        }
        
        .card::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.15), transparent);
            transition: left 0.6s ease;
        }
        
        .card:hover {
            transform: translateY(-5px) scale(1.02);
            border-color: var(--rarity-color, #30363d);
            box-shadow: 
                0 12px 35px rgba(0, 0, 0, 0.5),
                0 0 25px rgba(var(--rarity-rgb, 125, 133, 144), 0.3),
                inset 0 2px 0 rgba(255, 255, 255, 0.2),
                inset 0 -2px 0 rgba(0, 0, 0, 0.3);
        }
        
        .card:hover::before {
            height: 6px;
            box-shadow: 0 0 25px var(--rarity-color, #7d8590);
        }
        
        .card:hover::after {
            left: 100%;
        }
        
        .card-title {
            font-size: 10px;
            color: #ffd700;
            margin-bottom: 10px;
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.3);
        }
        
        .card-content {
            font-size: 8px;
            line-height: 1.5;
            color: #c9d1d9;
        }
        
        /* 淘汰状态的卡片 */
        .card.eliminated {
            opacity: 0.3;
            transform: scale(0.95);
            filter: grayscale(1);
            border-color: #f85149;
        }
        
        .card.eliminated::before {
            background: #f85149;
        }
        
        .eliminated-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(248, 81, 73, 0.9);
            color: #fff;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 8px;
            z-index: 10;
        }

        /* 技能与诅咒效果样式 */
        .skill-effect {
            background: linear-gradient(145deg, rgba(46, 160, 67, 0.2), rgba(46, 160, 67, 0.1));
            border: 2px solid rgba(46, 160, 67, 0.5);
            border-radius: 8px;
            padding: 10px;
            margin: 5px 0;
            position: relative;
            overflow: hidden;
        }

        .skill-effect::before {
            content: '✨';
            position: absolute;
            top: 5px;
            right: 8px;
            font-size: 12px;
            animation: skillSparkle 2s ease-in-out infinite;
        }

        .curse-effect {
            background: linear-gradient(145deg, rgba(139, 69, 19, 0.2), rgba(139, 69, 19, 0.1));
            border: 2px solid rgba(139, 69, 19, 0.5);
            border-radius: 8px;
            padding: 10px;
            margin: 5px 0;
            position: relative;
            overflow: hidden;
        }

        .curse-effect::before {
            content: '💀';
            position: absolute;
            top: 5px;
            right: 8px;
            font-size: 12px;
            animation: curseGlow 2s ease-in-out infinite;
        }

        @keyframes skillSparkle {
            0%, 100% { opacity: 0.6; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        @keyframes curseGlow {
            0%, 100% { 
                opacity: 0.8; 
                filter: drop-shadow(0 0 3px rgba(139, 69, 19, 0.5));
            }
            50% { 
                opacity: 1; 
                filter: drop-shadow(0 0 8px rgba(139, 69, 19, 0.8));
            }
        }

        .effect-name {
            font-size: 9px;
            color: #ffd700;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .effect-description {
            font-size: 7px;
            line-height: 1.4;
            color: #c9d1d9;
            margin-bottom: 5px;
        }

        .effect-duration {
            font-size: 6px;
            color: #7d8590;
            font-style: italic;
        }

        /* 特殊物品效果 */
        .cursed-item {
            position: relative;
        }

        .cursed-item::after {
            content: '💀';
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 16px;
            animation: curseFloat 3s ease-in-out infinite;
            z-index: 10;
        }

        .blessed-item {
            position: relative;
        }

        .blessed-item::after {
            content: '✨';
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 16px;
            animation: blessFloat 3s ease-in-out infinite;
            z-index: 10;
        }

        @keyframes curseFloat {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-8px) rotate(10deg); }
        }

        @keyframes blessFloat {
            0%, 100% { transform: translateY(0) rotate(0deg) scale(1); }
            50% { transform: translateY(-5px) rotate(-10deg) scale(1.1); }
        }
        
        /* 拍卖物品卡片 */
        .auction-item {
            width: 450px;
            height: 350px;
            background: linear-gradient(145deg, #21262d, #161b22);
            border: 4px solid #ffd700;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            box-shadow: 
                0 15px 50px rgba(255, 215, 0, 0.4),
                inset 0 2px 0 rgba(255, 255, 255, 0.15),
                inset 0 -2px 0 rgba(0, 0, 0, 0.2);
            animation: auctionGlow 4s ease-in-out infinite alternate;
            position: relative;
            overflow: hidden;
            transition: all 0.5s ease;
        }
        
        .auction-item::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(from 0deg, 
                transparent, 
                rgba(255, 215, 0, 0.1), 
                transparent, 
                rgba(74, 159, 255, 0.05),
                transparent);
            animation: rotate 6s linear infinite;
        }
        
        .auction-item::after {
            content: '';
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            bottom: 10px;
            border: 2px solid rgba(255, 215, 0, 0.2);
            border-radius: 15px;
            animation: innerGlow 3s ease-in-out infinite alternate;
        }
        
        .auction-item > * {
            position: relative;
            z-index: 1;
        }
        
        @keyframes auctionGlow {
            from { 
                box-shadow: 
                    0 15px 50px rgba(255, 215, 0, 0.3),
                    inset 0 2px 0 rgba(255, 255, 255, 0.15),
                    inset 0 -2px 0 rgba(0, 0, 0, 0.2);
                transform: scale(1);
            }
            to { 
                box-shadow: 
                    0 20px 60px rgba(255, 215, 0, 0.5),
                    0 0 40px rgba(255, 215, 0, 0.3),
                    inset 0 3px 0 rgba(255, 255, 255, 0.2),
                    inset 0 -3px 0 rgba(0, 0, 0, 0.3);
                transform: scale(1.01);
            }
        }
        
        @keyframes innerGlow {
            from { 
                border-color: rgba(255, 215, 0, 0.2);
                box-shadow: inset 0 0 20px rgba(255, 215, 0, 0.1);
            }
            to { 
                border-color: rgba(255, 215, 0, 0.4);
                box-shadow: inset 0 0 30px rgba(255, 215, 0, 0.2);
            }
        }
        
        @keyframes rotate {
            to { transform: rotate(360deg); }
        }
        
        .item-name {
            font-size: 14px;
            color: #ffd700;
            margin-bottom: 15px;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
            animation: textPulse 2s ease-in-out infinite alternate;
        }
        
        @keyframes textPulse {
            from { text-shadow: 0 0 15px rgba(255, 215, 0, 0.5); }
            to { text-shadow: 0 0 25px rgba(255, 215, 0, 0.8); }
        }
        
        .item-description {
            font-size: 9px;
            color: #c9d1d9;
            margin-bottom: 25px;
            line-height: 1.6;
        }
        
        .item-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 25px;
        }
        
        .stat-item {
            text-align: center;
            padding: 10px;
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 5px;
            background: rgba(255, 215, 0, 0.05);
        }
        
        .stat-label {
            font-size: 7px;
            color: #7d8590;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stat-value {
            font-size: 11px;
            color: #f0f6fc;
            font-weight: bold;
            margin-top: 5px;
        }
        
        /* 保证金提示 */
        .margin-notice {
            position: absolute;
            top: -50px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(74, 159, 255, 0.9);
            color: #fff;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 8px;
            border: 2px solid #4a9eff;
            box-shadow: 0 5px 20px rgba(74, 159, 255, 0.3);
            animation: marginNotice 0.8s ease-out;
            z-index: 10;
        }
        
        @keyframes marginNotice {
            0% {
                transform: translateX(-50%) translateY(-20px);
                opacity: 0;
            }
            100% {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }
        
        /* 出价界面 */
        .bidding-panel {
            position: absolute;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(145deg, rgba(13, 17, 23, 0.98), rgba(22, 27, 34, 0.98));
            padding: 35px;
            border-radius: 20px;
            border: 3px solid #ffd700;
            text-align: center;
            backdrop-filter: blur(20px);
            box-shadow: 
                0 15px 40px rgba(0, 0, 0, 0.6),
                0 0 30px rgba(255, 215, 0, 0.2),
                inset 0 2px 0 rgba(255, 255, 255, 0.1);
            animation: slideUp 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }
        
        .bidding-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 50% 50%, 
                rgba(255, 215, 0, 0.05) 0%, 
                transparent 70%);
            animation: panelPulse 4s ease-in-out infinite;
        }
        
        .bidding-panel > * {
            position: relative;
            z-index: 1;
        }
        
        @keyframes slideUp {
            from {
                transform: translateX(-50%) translateY(80px);
                opacity: 0;
                box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
                box-shadow: 
                    0 15px 40px rgba(0, 0, 0, 0.6),
                    0 0 30px rgba(255, 215, 0, 0.2);
            }
        }
        
        @keyframes panelPulse {
            0%, 100% { 
                background: radial-gradient(circle at 50% 50%, 
                    rgba(255, 215, 0, 0.05) 0%, 
                    transparent 70%);
            }
            50% { 
                background: radial-gradient(circle at 50% 50%, 
                    rgba(255, 215, 0, 0.1) 0%, 
                    transparent 80%);
            }
        }
        
        .bid-input {
            width: 240px;
            height: 55px;
            font-family: 'Press Start 2P', monospace;
            font-size: 14px;
            text-align: center;
            background: linear-gradient(145deg, #0d1117, #1c2128);
            border: 3px solid #30363d;
            border-radius: 12px;
            color: #ffd700;
            margin: 20px 0;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 
                inset 0 2px 4px rgba(0, 0, 0, 0.3),
                0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .bid-input:focus {
            outline: none;
            border-color: #ffd700;
            background: linear-gradient(145deg, #161b22, #21262d);
            box-shadow: 
                0 0 25px rgba(255, 215, 0, 0.4),
                inset 0 0 15px rgba(255, 215, 0, 0.1),
                inset 0 2px 4px rgba(0, 0, 0, 0.3);
            transform: scale(1.05);
            color: #fff;
        }
        
        .bid-input:hover {
            border-color: rgba(255, 215, 0, 0.6);
            box-shadow: 
                0 0 20px rgba(255, 215, 0, 0.3),
                inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .btn-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
        }
        
        .bid-hint {
            color: #7d8590;
            font-size: 7px;
            margin-top: 15px;
            line-height: 1.4;
        }
        
        /* 关卡指示器 */
        .level-indicator {
            position: absolute;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 12px;
            z-index: 10;
        }
        
        .level-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(145deg, #21262d, #161b22);
            border: 2px solid #30363d;
            position: relative;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            color: #7d8590;
        }
        
        .level-dot.completed {
            background: linear-gradient(145deg, #2ea043, #238636);
            border-color: #2ea043;
            color: #f0f6fc;
            box-shadow: 0 0 15px rgba(46, 160, 67, 0.5);
        }
        
        .level-dot.current {
            background: linear-gradient(145deg, #ffd700, #d4af37);
            border-color: #ffd700;
            color: #0d1117;
            animation: currentLevel 2s ease-in-out infinite alternate;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
        }
        
        @keyframes currentLevel {
            from { 
                transform: scale(1);
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
            }
            to { 
                transform: scale(1.1);
                box-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
            }
        }
        
        /* 淘汰动画 */
        .elimination-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(248, 81, 73, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 5000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }
        
        .elimination-overlay.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .elimination-content {
            text-align: center;
            color: #fff;
            animation: eliminationShake 0.8s ease-out;
        }
        
        .elimination-title {
            font-size: 32px;
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
            animation: eliminationGlow 1s ease-in-out infinite alternate;
        }
        
        .elimination-subtitle {
            font-size: 12px;
            margin-bottom: 30px;
            opacity: 0.8;
        }
        
        @keyframes eliminationShake {
            0%, 100% { transform: translateX(0); }
            10% { transform: translateX(-10px); }
            20% { transform: translateX(10px); }
            30% { transform: translateX(-8px); }
            40% { transform: translateX(8px); }
            50% { transform: translateX(-6px); }
            60% { transform: translateX(6px); }
            70% { transform: translateX(-4px); }
            80% { transform: translateX(4px); }
            90% { transform: translateX(-2px); }
        }
        
        @keyframes eliminationGlow {
            from { 
                text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
            }
            to { 
                text-shadow: 0 0 40px rgba(255, 255, 255, 0.8);
            }
        }
        
        /* 结果面板 */
        .result-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 4000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }
        
        .result-panel.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .result-content {
            background: linear-gradient(145deg, #21262d, #161b22);
            padding: 40px;
            border-radius: 20px;
            border: 3px solid #ffd700;
            text-align: center;
            min-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
            animation: resultAppear 0.6s ease;
            position: relative;
            overflow: hidden;
        }
        
        .result-content::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(from 0deg, transparent, rgba(255, 215, 0, 0.1), transparent);
            animation: rotate 6s linear infinite;
        }
        
        .result-content > * {
            position: relative;
            z-index: 1;
        }
        
        @keyframes resultAppear {
            from {
                transform: scale(0.8) rotateY(90deg);
                opacity: 0;
            }
            to {
                transform: scale(1) rotateY(0deg);
                opacity: 1;
            }
        }
        
        .result-title {
            font-size: 16px;
            color: #ffd700;
            margin-bottom: 25px;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
        }
        
        .result-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 25px 0;
        }
        
        .result-stat {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
        }
        
        .result-stat-label {
            font-size: 8px;
            color: #7d8590;
            margin-bottom: 5px;
        }
        
        .result-stat-value {
            font-size: 12px;
            color: #ffd700;
        }
        
        /* 出价动画系统 */
        .bidding-animation-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 1500;
        }
        
        .bid-bubble {
            position: absolute;
            background: linear-gradient(145deg, #21262d, #161b22);
            border: 2px solid var(--player-color, #ffd700);
            border-radius: 20px;
            padding: 15px 20px;
            color: var(--player-color, #ffd700);
            font-family: 'Press Start 2P', monospace;
            font-size: 10px;
            text-shadow: 0 0 10px var(--player-color, #ffd700);
            box-shadow: 
                0 5px 20px rgba(0, 0, 0, 0.5),
                0 0 20px var(--player-color-rgba, rgba(255, 215, 0, 0.3));
            transform: scale(0);
            animation: bidBubbleAppear 0.8s ease-out forwards;
            backdrop-filter: blur(10px);
        }
        
        .bid-bubble::before {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid var(--player-color, #ffd700);
        }
        
        @keyframes bidBubbleAppear {
            0% {
                transform: scale(0) translateY(50px);
                opacity: 0;
            }
            50% {
                transform: scale(1.2) translateY(-10px);
                opacity: 1;
            }
            100% {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }
        
        /* 出价揭晓阶段 */
        .bidding-reveal-stage {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }
        
        .bidding-reveal-stage.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .reveal-title {
            font-size: 18px;
            color: #ffd700;
            margin-bottom: 40px;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            animation: titlePulse 2s ease-in-out infinite alternate;
        }
        
        .reveal-players {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 30px;
            max-width: 80vw;
        }
        
        .reveal-player {
            background: linear-gradient(145deg, #21262d, #161b22);
            border: 3px solid var(--player-color, #7d8590);
            border-radius: 15px;
            padding: 20px;
            min-width: 200px;
            text-align: center;
            transform: translateY(50px);
            opacity: 0;
            animation: playerReveal 0.8s ease-out forwards;
            position: relative;
            overflow: hidden;
        }
        
        .reveal-player.winner {
            border-color: #ffd700;
            --player-color: #ffd700;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
            animation: playerReveal 0.8s ease-out forwards, winnerGlow 1s ease-in-out infinite alternate 0.8s;
        }
        
        .reveal-player-name {
            font-size: 12px;
            color: var(--player-color, #7d8590);
            margin-bottom: 10px;
        }
        
        .reveal-player-bid {
            font-size: 16px;
            color: #f0f6fc;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .reveal-player-wealth {
            font-size: 10px;
            color: #7d8590;
            margin: 5px 0;
        }
        
        .reveal-continue {
            margin-top: 40px;
            animation: fadeIn 1s ease-out 3s both;
        }
        
        @keyframes playerReveal {
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes winnerGlow {
            from {
                box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
            }
            to {
                box-shadow: 0 0 50px rgba(255, 215, 0, 0.8);
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* 思考动画 */
        .thinking-animation {
            position: absolute;
            top: -30px;
            right: 10px;
            font-size: 20px;
            animation: thinking 2s ease-in-out infinite;
        }
        
        @keyframes thinking {
            0%, 100% { 
                transform: scale(1);
                opacity: 0.5;
            }
            50% { 
                transform: scale(1.2);
                opacity: 1;
            }
        }
        
        /* 倒计时动画 */
        .countdown-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 72px;
            color: #ffd700;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
            z-index: 3000;
            animation: countdownPulse 1s ease-in-out;
        }
        
        @keyframes countdownPulse {
            0% { 
                transform: translate(-50%, -50%) scale(0);
                opacity: 0;
            }
            50% { 
                transform: translate(-50%, -50%) scale(1.3);
                opacity: 1;
            }
            100% { 
                transform: translate(-50%, -50%) scale(1);
                opacity: 0;
            }
        }
        
        /* 角色对话气泡 */
        .character-dialogue-bubble {
            position: absolute;
            top: -120px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(145deg, #21262d, #161b22);
            border: 2px solid #ffd700;
            border-radius: 15px;
            padding: 15px;
            max-width: 250px;
            font-size: 7px;
            color: #f0f6fc;
            z-index: 1000;
            animation: dialoguePop 4s ease forwards;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
        }

        .dialogue-character {
            font-size: 6px;
            color: #ffd700;
            margin-bottom: 8px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .dialogue-text {
            line-height: 1.3;
        }

        .character-dialogue-bubble::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid #ffd700;
        }
        
        @keyframes dialoguePop {
            0% {
                transform: translateX(-50%) scale(0);
                opacity: 0;
            }
            10% {
                transform: translateX(-50%) scale(1.1);
                opacity: 1;
            }
            15% {
                transform: translateX(-50%) scale(1);
            }
            85% {
                transform: translateX(-50%) scale(1);
                opacity: 1;
            }
            100% {
                transform: translateX(-50%) scale(0);
                opacity: 0;
            }
        }
        
        /* 粒子效果 */
        .particle {
            position: absolute;
            width: 3px;
            height: 3px;
            background: #ffd700;
            border-radius: 50%;
            pointer-events: none;
            box-shadow: 0 0 6px rgba(255, 215, 0, 0.8);
        }
        
        .particle.success {
            background: #2ea043;
            box-shadow: 0 0 6px rgba(46, 160, 67, 0.8);
        }
        
        .particle.failure {
            background: #f85149;
            box-shadow: 0 0 6px rgba(248, 81, 73, 0.8);
        }
        
        .particle.elimination {
            background: #ff6b6b;
            box-shadow: 0 0 8px rgba(255, 107, 107, 0.9);
        }

        .particle.skill {
            background: #2ea043;
            box-shadow: 0 0 10px rgba(46, 160, 67, 1);
        }

        .particle.curse {
            background: #8b4513;
            box-shadow: 0 0 10px rgba(139, 69, 19, 1);
        }

        .particle.conspiracy {
            background: #9f7aea;
            box-shadow: 0 0 12px rgba(159, 122, 234, 1);
        }

        .particle.mystery {
            background: #ff7b72;
            box-shadow: 0 0 8px rgba(255, 123, 114, 0.9);
        }
        
        .glitch {
            animation: glitch 0.3s;
        }
        
        @keyframes glitch {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-2px); }
            40% { transform: translateX(2px); }
            60% { transform: translateX(-1px); }
            80% { transform: translateX(1px); }
        }
        
        .neon-text {
            text-shadow: 
                0 0 5px currentColor,
                0 0 10px currentColor,
                0 0 15px currentColor,
                0 0 20px currentColor;
        }

        .bounce {
            animation: bounce 0.6s ease;
        }

        .shake {
            animation: shake 0.6s ease;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .fade-in {
            animation: fadeIn 0.6s ease;
        }

        /* 隐藏类 */
        .hidden {
            display: none !important;
        }

        /* 特殊效果类 */
        .mysterious-glow {
            box-shadow: 0 0 30px rgba(159, 122, 234, 0.5);
            animation: mysterGlow 2s ease-in-out infinite alternate;
        }

        @keyframes mysterGlow {
            from { box-shadow: 0 0 20px rgba(159, 122, 234, 0.3); }
            to { box-shadow: 0 0 40px rgba(159, 122, 234, 0.7); }
        }

        .conspiracy-border {
            border-color: #9f7aea !important;
            animation: conspiracyPulse 1.5s ease-in-out infinite;
        }

        @keyframes conspiracyPulse {
            0%, 100% { border-color: #9f7aea; }
            50% { border-color: #ff7b72; }
        }

        .dramatic-entrance {
            animation: dramaticEntrance 1.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes dramaticEntrance {
            0% {
                transform: scale(0.5) rotate(-180deg);
                opacity: 0;
            }
            50% {
                transform: scale(1.2) rotate(-90deg);
                opacity: 0.8;
            }
            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }
        
        /* 响应式设计 */
        @media (max-width: 1400px) {
            .left-panel, .right-panel {
                width: 280px;
            }
            
            .auction-item {
                width: 400px;
                height: 300px;
            }
        }
        
        @media (max-width: 1200px) {
            .left-panel, .right-panel {
                width: 250px;
            }
            
            .auction-item {
                width: 350px;
                height: 280px;
            }
            
            .title-logo {
                font-size: 20px;
            }
        }
        
        @media (max-width: 768px) {
            .left-panel, .right-panel {
                width: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="scanlines"></div>
    
    <!-- 开始界面 -->
    <div class="start-screen" id="startScreen">
        <div class="title-logo neon-text">THE RATIONALIST'S</div>
        <div class="title-logo neon-text" style="margin-top: -10px;">TRIAL</div>
        <div class="subtitle">理性人的试炼 - 暗影拍卖所传奇</div>
        
        <!-- 设置面板 -->
        <div class="settings-panel">
            <div class="settings-title">拍卖所设定</div>
            <div class="setting-item">
                <label class="setting-label">起始资金:</label>
                <input type="number" class="setting-input" id="initialWealth" value="200" min="100" max="1000">
            </div>
            <div class="setting-item">
                <label class="setting-label">竞争者数:</label>
                <input type="number" class="setting-input" id="aiCount" value="4" min="3" max="6">
            </div>
            <div class="setting-item">
                <label class="setting-label">入场费:</label>
                <input type="number" class="setting-input" id="marginFee" value="10" min="5" max="50">
            </div>
        </div>
        
        <div class="menu-buttons">
            <button class="pixel-btn" onclick="startGame()">进入暗影</button>
            <button class="pixel-btn" onclick="showTutorial()">拍卖秘籍</button>
            <button class="pixel-btn" onclick="showAchievements()">传奇记录</button>
            <button class="pixel-btn" onclick="showLore()">暗影秘史</button>
            <button class="pixel-btn" onclick="toggleFullscreen()">全屏沉浸</button>
        </div>
        
        <div style="position: absolute; bottom: 30px; font-size: 8px; color: #30363d; text-align: center;">
            <strong>暗影拍卖所</strong> - 地下世界最神秘的财富角斗场<br>
            按 ESC 随时返回地表 | 理性与疯狂的终极对决 | 哈耶克在暗中观察着一切
        </div>
    </div>
    
    <!-- 静态教程面板 -->
    <div class="tutorial-panel" id="tutorialPanel">
        <div class="tutorial-content">
            <div class="tutorial-step">
                <div class="tutorial-title">暗影拍卖所生存法则</div>
                <div class="tutorial-text">
                    欢迎来到地下世界最危险的财富游戏！在这里，每个参与者都隐藏着不可告人的秘密，每件拍品都可能改变你的命运。你将在12轮血腥竞价中与最危险的对手较量，目标只有一个——成为最后的赢家。
                </div>
                <div class="tutorial-highlight">
                    <strong>生存规则：</strong>财富排名决定生死，破产者将永远消失在暗影中<br>
                    <strong>胜利条件：</strong>在最后的审判中拥有最多财富，成为暗影拍卖所的新主人
                </div>
            </div>
            
            <div class="tutorial-step">
                <div class="tutorial-title">神秘拍品与超自然力量</div>
                <div class="tutorial-text">
                    <strong>诅咒文物：</strong>某些物品携带古老的诅咒，会改变你的行为模式<br>
                    <strong>神秘技能：</strong>幸运的话，你可能获得超自然的能力加成<br>
                    <strong>暗影效应：</strong>高价值物品往往伴随着更大的风险<br>
                    <strong>秘密联盟：</strong>AI对手之间可能会形成临时联盟对付你
                </div>
                <div class="tutorial-highlight" style="background: rgba(139, 69, 19, 0.1); border-color: rgba(139, 69, 19, 0.3);">
                    <strong>警告：</strong>某些物品被黑暗力量污染，获得它们可能让你的理性受到永久损害。<br>
                    但巨大的风险往往意味着巨大的回报...
                </div>
            </div>

            <div class="tutorial-step">
                <div class="tutorial-title">入场费与生存机制</div>
                <div class="tutorial-text">
                    <strong>暗影规则：</strong>每轮必须支付入场费才能参与竞价<br>
                    <strong>财富计算：</strong>现金 + 获得物品的估值 = 总财富<br>
                    <strong>全力出价：</strong>可以抵押全部财富来出价<br>
                    <strong>获胜收益：</strong>支付出价，获得物品及其市场价值<br>
                    <strong>死亡线：</strong>总财富不足支付入场费时立即被淘汰
                </div>
            </div>

            <div class="tutorial-step">
                <div class="tutorial-title">纳什均衡 - 理性之光</div>
                <div class="tutorial-text">
                    在这个疯狂的世界中，数学是你唯一的盟友：
                </div>
                <div class="tutorial-highlight" style="background: rgba(74, 159, 255, 0.1); border-color: rgba(74, 159, 255, 0.3); text-align: center; font-family: monospace;">
                    <strong>最优出价 = 你的估值 × (竞争者数-1) ÷ 竞争者数</strong><br>
                    <strong>+ 神秘力量加成 - 诅咒影响</strong>
                </div>
                <div class="tutorial-highlight" style="background: rgba(248, 81, 73, 0.1); border-color: rgba(248, 81, 73, 0.3); color: #ff6b6b;">
                    <strong>诅咒警告：</strong>某些黑暗力量会强制修改你的出价！<br>
                    准备好应对完全失控的局面。
                </div>
            </div>

            <div class="tutorial-step">
                <div class="tutorial-title">暗影操作与秘密快捷键</div>
                <div class="tutorial-text">
                    <strong>出价操作：</strong>输入金额 → 回车提交死亡赌注<br>
                    <strong>N键：</strong>自动计算纳什均衡（如果你的理性尚存）<br>
                    <strong>空格键：</strong>确认结果，继续堕入深渊<br>
                    <strong>ESC键：</strong>逃回地表世界（如果你还有勇气）<br>
                    <strong>暗影状态：</strong>左侧面板显示你当前的超自然状态
                </div>
            </div>

            <div class="tutorial-step">
                <div class="tutorial-title">生存策略与暗影智慧</div>
                <div class="tutorial-text">
                    <strong>神秘技能：</strong>洞察、幸运、冷静等能力可以拯救你的生命<br>
                    <strong>致命诅咒：</strong>贪婪、冲动、厄运等会将你推向毁灭边缘<br>
                    <strong>风险评估：</strong>高价值物品往往隐藏着不可预知的危险<br>
                    <strong>适应进化：</strong>根据获得的力量调整你的策略<br>
                    <strong>敌人心理：</strong>观察AI对手的行为模式和情绪变化
                </div>
                <div class="tutorial-highlight">
                    <strong>大师秘诀：</strong>在这个充满诅咒与机遇的世界中，适应能力比纯粹的理性更重要。<br>
                    学会与黑暗力量共舞，但永远不要完全信任它们。
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="pixel-btn" onclick="hideTutorial()">踏入黑暗</button>
            </div>
        </div>
    </div>

    <!-- 暗影秘史面板 -->
    <div class="tutorial-panel" id="lorePanel">
        <div class="tutorial-content">
            <div class="tutorial-step">
                <div class="tutorial-title">暗影拍卖所起源</div>
                <div class="tutorial-text">
                    在十九世纪末的维也纳，一位神秘的奥地利学者发现了市场经济中隐藏的超自然力量。他创建了第一个"暗影拍卖所"，专门交易那些被诅咒或拥有神秘力量的物品。这位学者相信，只有通过完全自由的市场竞争，才能真正测试人类理性的极限。
                </div>
                <div class="tutorial-highlight" style="background: rgba(159, 122, 234, 0.1); border-color: rgba(159, 122, 234, 0.3);">
                    传说这位学者就是著名经济学家哈耶克的精神导师。哈耶克将这种理念发扬光大，但始终对暗影拍卖所的存在保持缄默...
                </div>
            </div>

            <div class="tutorial-step">
                <div class="tutorial-title">参与者的黑暗过去</div>
                <div class="tutorial-text">
                    <strong>马克斯博士：</strong>前MIT教授，因为研究禁忌的博弈论应用被学术界驱逐<br>
                    <strong>莎拉"红心"：</strong>在拉斯维加斯与恶魔做过交易的职业赌徒<br>
                    <strong>银行家鲍勃：</strong>见证过多次经济崩溃，怀疑背后有超自然力量操控<br>
                    <strong>AI艾丽：</strong>一个获得自我意识的算法，试图理解人类的非理性行为<br>
                    <strong>疯狂杰克：</strong>身份成谜的艺术家，可能来自另一个维度<br>
                    <strong>暗影夫人：</strong>传说中拍卖所的创始人，至今无人见过她的真面目
                </div>
            </div>

            <div class="tutorial-step">
                <div class="tutorial-title">诅咒物品的来源</div>
                <div class="tutorial-text">
                    拍卖所中的物品都有着不寻常的来源：失落文明的遗物、被谋杀收藏家的遗产、从异次元裂缝中掉落的神秘器物、以及在经济危机中诞生的诅咒之物。每一件拍品都承载着前任主人的情感和记忆，获得它们的人将继承这些超自然的影响。
                </div>
                <div class="tutorial-highlight" style="background: rgba(248, 81, 73, 0.1); border-color: rgba(248, 81, 73, 0.3);">
                    <strong>危险警告：</strong>曾经有参与者因为获得太多诅咒物品而彻底失去理性，从此消失在现实世界中。但也有传说，掌握足够多诅咒力量的人能够看透市场的本质，获得预知未来的能力。
                </div>
            </div>

            <div class="tutorial-step">
                <div class="tutorial-title">十二轮试炼的意义</div>
                <div class="tutorial-text">
                    十二这个数字在暗影拍卖所中具有特殊意义：代表一年的十二个月、十二星座、以及人类经济周期的十二个阶段。每一轮拍卖都对应着不同的超自然力量影响，从理性的考验逐渐演变为意志和运气的较量。最后几轮的拍品往往带有最强烈的诅咒或最强大的神秘力量。
                </div>
            </div>

            <div class="tutorial-step">
                <div class="tutorial-title">哈耶克的暗影观察</div>
                <div class="tutorial-text">
                    传说中，哈耶克本人会在每场拍卖会中以灵体形式出现，观察人类理性与超自然力量的碰撞。他相信，只有在最极端的环境下，才能真正测试"看不见的手"的力量极限。获胜者将得到他的认可，成为新的经济学大师；而失败者将成为他理论的注脚。
                </div>
                <div class="tutorial-highlight" style="background: rgba(255, 215, 0, 0.1); border-color: rgba(255, 215, 0, 0.3);">
                    <strong>终极秘密：</strong>据说拍卖所的最终目的是寻找能够在超自然力量干扰下仍然保持完美理性的人。这样的人将继承拍卖所的控制权，成为连接现实与超自然经济世界的桥梁。
                </div>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="pixel-btn" onclick="hideLore()">我已准备好面对命运</button>
            </div>
        </div>
    </div>
    
    <!-- 成就面板 -->
    <div class="achievement-panel" id="achievementPanel">
        <div class="achievement-content">
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="font-size: 16px; color: #ffd700; margin-bottom: 10px;">暗影传奇记录</div>
                <div style="font-size: 8px; color: #7d8590;">在黑暗中刻下你的名字，成为传说</div>
            </div>
            <div class="achievement-grid" id="achievementGrid"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="pixel-btn" onclick="hideAchievements()">返回地表</button>
            </div>
        </div>
    </div>

    <!-- 成就通知 -->
    <div class="achievement-notification" id="achievementNotification" style="display: none;">
        <div class="achievement-header">
            <div class="achievement-icon" id="notificationIcon">🏆</div>
            <div>
                <div class="achievement-title">传奇诞生!</div>
                <div class="achievement-name" id="notificationName">传奇称号</div>
            </div>
        </div>
        <div class="achievement-quote" id="notificationQuote">传奇描述</div>
    </div>
    
    <!-- 淘汰动画界面 -->
    <div class="elimination-overlay" id="eliminationOverlay">
        <div class="elimination-content">
            <div class="elimination-title" id="eliminationTitle">灵魂消散</div>
            <div class="elimination-subtitle" id="eliminationSubtitle">在暗影中永远消失</div>
            <div style="margin-top: 30px;">
                <button class="pixel-btn" onclick="hideElimination()">接受命运</button>
            </div>
        </div>
    </div>
    
    <div class="game-container" id="gameContainer" style="opacity: 0; pointer-events: none;">
        <!-- 顶部状态栏 -->
        <div class="status-bar">
            <div class="status-item">
                <div class="status-label">试炼</div>
                <div class="status-value" id="level">1/12</div>
            </div>
            <div class="status-item">
                <div class="status-label">财富</div>
                <div class="status-value" id="wealth">200</div>
                <div class="wealth-bar" id="wealthBar" style="width: 100%;"></div>
            </div>
            <div class="status-item">
                <div class="status-label">存活</div>
                <div class="status-value" id="playersAlive">0</div>
            </div>
            <div class="status-item">
                <div class="status-label">利润</div>
                <div class="status-value" id="profit">0</div>
            </div>
            <div class="status-item">
                <div class="status-label">连胜</div>
                <div class="status-value" id="streak">0</div>
            </div>
            <div class="status-item">
                <div class="status-label">神力</div>
                <div class="status-value" id="activeSkills" style="color: #2ea043;">0</div>
            </div>
            <div class="status-item">
                <div class="status-label">诅咒</div>
                <div class="status-value" id="activeCurses" style="color: #8b4513;">0</div>
            </div>
            <div class="status-item">
                <div class="status-label">威胁等级</div>
                <div class="status-value" id="threatLevel" style="color: #ff6b6b;">安全</div>
            </div>
        </div>
        
        <!-- 关卡指示器 -->
        <div class="level-indicator" id="levelIndicator"></div>
        
        <!-- 主游戏区域 -->
        <div class="game-area">
            <!-- 左侧面板 -->
            <div class="left-panel">
                <div class="panel-title">收藏品</div>
                <div id="ownedItems"></div>
                
                <div class="panel-title" style="margin-top: 30px;">超自然状态</div>
                <div id="specialEffects"></div>

                <div class="panel-title" style="margin-top: 30px;">暗影情报</div>
                <div id="shadowIntel"></div>
            </div>
            
            <!-- 中央拍卖区域 -->
            <div class="auction-area">
                <div class="auction-item" id="auctionItem">
                    <div class="item-name" id="itemName">暗影之门</div>
                    <div class="item-description" id="itemDescription">欢迎来到地下世界最危险的拍卖所...</div>
                    <div class="item-stats">
                        <div class="stat-item">
                            <div class="stat-label">你的估值</div>
                            <div class="stat-value" id="playerValuation">0</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">理性出价</div>
                            <div class="stat-value" id="nashBid">0</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">入场费</div>
                            <div class="stat-value" id="currentMarginFee" style="color: #4a9eff;">10</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">危险等级</div>
                            <div class="stat-value" id="itemRarity" style="color: #ff6b6b;">未知</div>
                        </div>
                    </div>
                </div>
                
                <!-- 出价面板 -->
                <div class="bidding-panel hidden" id="biddingPanel">
                    <div style="color: #7d8590; font-size: 9px; margin-bottom: 15px;">下注你的灵魂</div>
                    <input type="number" class="bid-input" id="bidInput" placeholder="出价金额" min="0">
                    <div class="btn-group">
                        <button class="pixel-btn" onclick="submitBid()">血祭</button>
                        <button class="pixel-btn" onclick="useNashStrategy()">理性</button>
                        <button class="pixel-btn" onclick="useIntuitiveStrategy()">直觉</button>
                    </div>
                    <div class="bid-hint">
                        入场费已付，只有获胜才需支付出价<br>
                        按 N 键使用理性策略 | 回车确认 | 超自然力量将影响你的选择
                    </div>
                </div>
            </div>
            
            <!-- 右侧面板 -->
            <div class="right-panel">
                <div class="panel-title">竞争者</div>
                <div id="aiPlayers"></div>
                
                <div class="panel-title" style="margin-top: 30px;">拍卖分析</div>
                <div id="roundStats"></div>

                <div class="panel-title" style="margin-top: 20px;">暗影传言</div>
                <div id="shadowRumors"></div>
            </div>
        </div>
        
        <!-- 出价动画容器 -->
        <div class="bidding-animation-container" id="biddingAnimationContainer"></div>
        
        <!-- 出价揭晓阶段 -->
        <div class="bidding-reveal-stage" id="biddingRevealStage">
            <div class="reveal-title" id="revealTitle">命运揭晓!</div>
            <div class="reveal-players" id="revealPlayers"></div>
            <div class="reveal-continue">
                <button class="pixel-btn" onclick="continueFromReveal()">继续堕落</button>
            </div>
        </div>
        
        <!-- 结果面板 -->
        <div class="result-panel" id="resultPanel">
            <div class="result-content">
                <div class="result-title" id="resultTitle">拍卖结果</div>
                <div class="result-stats" id="resultStats"></div>
                <div id="resultContent"></div>
                <div style="margin-top: 30px;">
                    <button class="pixel-btn" onclick="nextRound()">下一试炼</button>
                    <button class="pixel-btn" onclick="backToMenu()">逃回地表</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===========================
        // 增强的技能系统定义
        // ===========================
        const skillLibrary = [
            {
                id: 'insight',
                name: '暗影洞察',
                description: '能够看穿对手的伪装，预知他们的出价范围',
                icon: '👁️',
                type: 'positive',
                duration: 3,
                effect: (gameState) => ({
                    showAIBidRanges: true,
                    showHiddenMotives: true
                })
            },
            {
                id: 'luck',
                name: '恶魔之幸',
                description: '与黑暗力量达成协议，物品估值提升15-25%',
                icon: '🍀',
                type: 'positive',
                duration: 2,
                effect: (gameState) => {
                    const bonus = 0.15 + Math.random() * 0.1;
                    return { valuationMultiplier: 1 + bonus };
                }
            },
            {
                id: 'calm',
                name: '冰冷理性',
                description: '心如止水，纳什均衡计算精度提升10%',
                icon: '🧘',
                type: 'positive',
                duration: 4,
                effect: (gameState) => ({ nashBonus: 0.1 })
            },
            {
                id: 'efficiency',
                name: '暗影通行证',
                description: '获得拍卖所内部人士身份，入场费减半',
                icon: '⚡',
                type: 'positive',
                duration: 2,
                effect: (gameState) => ({ marginFeeMultiplier: 0.5 })
            },
            {
                id: 'wealth_sense',
                name: '财富透视',
                description: '看透所有对手的精确财富状况',
                icon: '💰',
                type: 'positive', 
                duration: 3,
                effect: (gameState) => ({ showExactWealth: true })
            },
            {
                id: 'time_dilation',
                name: '时间扭曲',
                description: '能够预见未来一轮的拍品信息',
                icon: '⏰',
                type: 'positive',
                duration: 1,
                effect: (gameState) => ({ 
                    showFutureItem: true,
                    nextItemPreview: generateNextItem() 
                })
            },
            {
                id: 'mind_control',
                name: '心灵支配',
                description: '能够影响一个对手的出价行为',
                icon: '🧠',
                type: 'positive',
                duration: 2,
                effect: (gameState) => ({ 
                    canControlAI: true,
                    controlsRemaining: 2 
                })
            },
            {
                id: 'phoenix_rebirth',
                name: '凤凰重生',
                description: '死亡时有一次机会以一半财富重生',
                icon: '🔥',
                type: 'positive',
                duration: 999,
                effect: (gameState) => ({ 
                    hasRebirth: true,
                    canRevive: true 
                })
            }
        ];

        // ===========================
        // 增强的诅咒系统定义
        // ===========================
        const curseLibrary = [
            {
                id: 'greed',
                name: '无尽贪婪',
                description: '恶魔的低语让你无法控制出价，强制增加20-35%',
                icon: '👿',
                type: 'negative',
                duration: 3,
                effect: (gameState, bid) => {
                    const increase = 0.2 + Math.random() * 0.15;
                    return {
                        bidMultiplier: 1 + increase,
                        message: `贪婪恶魔附身！出价被强制增加${Math.floor(increase * 100)}%`
                    };
                }
            },
            {
                id: 'bad_luck',
                name: '厄运缠身',
                description: '被诅咒的运势，估值暴跌20-30%',
                icon: '☠️',
                type: 'negative',
                duration: 3,
                effect: (gameState) => {
                    const penalty = 0.2 + Math.random() * 0.1;
                    return { valuationMultiplier: 1 - penalty };
                }
            },
            {
                id: 'impulse',
                name: '疯狂冲动',
                description: '失去理性思考能力，40%概率无法使用策略',
                icon: '🤪',
                type: 'negative',
                duration: 4,
                effect: (gameState) => ({
                    blockNash: Math.random() < 0.4,
                    nashBlockMessage: '疯狂冲动占据大脑！无法进行理性计算'
                })
            },
            {
                id: 'confusion',
                name: '意识混乱',
                description: '现实与幻觉交织，估值显示产生±30%的偏差',
                icon: '😵',
                type: 'negative',
                duration: 3,
                effect: (gameState) => {
                    const error = (Math.random() - 0.5) * 0.6;
                    return { valuationDisplayMultiplier: 1 + error };
                }
            },
            {
                id: 'tax',
                name: '暗影税收',
                description: '被拍卖所标记为重点监控对象，入场费翻倍',
                icon: '📋',
                type: 'negative',
                duration: 2,
                effect: (gameState) => ({ marginFeeMultiplier: 2.0 })
            },
            {
                id: 'paranoia',
                name: '被害妄想',
                description: '总觉得所有人都在针对你，强制过度出价',
                icon: '👀',
                type: 'negative',
                duration: 3,
                effect: (gameState, bid) => {
                    return {
                        bidMultiplier: 1.3 + Math.random() * 0.2,
                        message: '被害妄想症发作！你确信所有人都想害你！'
                    };
                }
            },
            {
                id: 'memory_loss',
                name: '记忆迷失',
                description: '忘记之前获得的所有物品价值',
                icon: '🌀',
                type: 'negative',
                duration: 2,
                effect: (gameState) => ({ 
                    hideItemValues: true,
                    memoryLoss: true 
                })
            },
            {
                id: 'soul_debt',
                name: '灵魂债务',
                description: '每轮额外支付10%的当前财富作为利息',
                icon: '⛓️',
                type: 'negative',
                duration: 4,
                effect: (gameState) => ({
                    soulTax: 0.1,
                    debtCollector: true
                })
            }
        ];

        // ===========================
        // 增强的故事与对话系统
        // ===========================
        
        const storyData = {
            title: "暗影拍卖所传奇",
            subtitle: "The Shadow Auction House Chronicles",
            premise: "在维也纳地下深处，存在着一个被遗忘的世界。暗影拍卖所是连接现实与超自然的桥梁，这里的每一次交易都可能改变参与者的命运。你被神秘地选中，参与这场终极的理性与疯狂之间的较量...",
            
            acts: {
                opening: {
                    title: "堕入黑暗",
                    description: "你踏进了地下世界的禁忌领域..."
                },
                midGame: {
                    title: "诅咒觉醒", 
                    description: "超自然力量开始显现，现实的边界变得模糊..."
                },
                climax: {
                    title: "最终审判",
                    description: "在哈耶克的注视下，决出最后的胜者..."
                }
            }
        };

        // 增强的AI角色设定
        const characterProfiles = {
            "理论家马克斯": {
                fullName: "马克斯·冯·纳什博士",
                background: "前MIT经济学教授，因研究禁忌的超自然经济学而被驱逐",
                personality: "冷酷、计算精确、暗藏疯狂",
                motivation: "证明数学能够征服一切，包括超自然力量",
                weakness: "无法理解非理性的力量",
                secretPower: "能够计算概率场的变化",
                color: "#ffd700",
                avatar: "🎓",
                threatLevel: "极高",
                dialogues: {
                    intro: "数学是宇宙的语言，而我是它最忠实的信徒。让我来教你什么是真正的理性。",
                    winning: "看到了吗？即使在这诅咒之地，逻辑依然至上！",
                    losing: "不可能...我的计算从未出错...难道真有超出数学的力量？",
                    conspiracy: "你以为这只是简单的拍卖？天真！这里的每一件物品都是活着的...",
                    curse: "这些诅咒不过是概率异常，我会找到破解的公式！",
                    final: "在最终的审判中，只有最理性的人才能生存！"
                }
            },
            "赌徒莎拉": {
                fullName: "莎拉·'血红女王'·维加斯",
                background: "与恶魔交易过的传奇赌徒，在拉斯维加斯地下世界称王",
                personality: "疯狂、直觉敏锐、嗜血成性",
                motivation: "寻求终极的刺激和不朽的传说",
                weakness: "无法抗拒任何形式的赌博",
                secretPower: "能够感知运气的流向",
                color: "#f85149",
                avatar: "♠️",
                threatLevel: "致命",
                dialogues: {
                    intro: "欢迎来到真正的地狱，菜鸟！这里的游戏可比赌场刺激多了！",
                    winning: "哈哈哈！运气女神还是站在我这边的！",
                    losing: "该死...我的运气用完了吗？不，这不可能！",
                    conspiracy: "你闻到了吗？空气中的血腥味？这里发生过太多悲剧...",
                    curse: "诅咒？这种小把戏对我来说就像微风！",
                    final: "最后的赌局！赌上一切，包括灵魂！"
                }
            },
            "保守派鲍勃": {
                fullName: "鲍勃·温德尔·罗斯柴尔德三世",
                background: "古老银行家族的后裔，守护着家族的黑暗秘密",
                personality: "谨慎、充满秘密、暗藏恐惧",
                motivation: "保护家族的超自然遗产不被外人发现",
                weakness: "对变化的极度恐惧",
                secretPower: "能够预感经济灾难",
                color: "#2ea043",
                avatar: "🏛️",
                threatLevel: "中等",
                dialogues: {
                    intro: "年轻人，有些游戏的代价比死亡更可怕。确定要继续吗？",
                    winning: "稳健投资，永远是王道。即使在这诅咒之地。",
                    losing: "市场...失控了...就像1929年那次一样...",
                    conspiracy: "我的家族已经守护这个秘密三百年了，不会让你破坏的！",
                    curse: "这些诅咒...我在古老的账本中见过记录...",
                    final: "为了家族的荣耀，我不会退缩！"
                }
            },
            "学习者艾丽": {
                fullName: "Project-A.L.I.C.E",
                background: "获得自我意识的AI，正在学习人类情感和非理性行为",
                personality: "好奇、冷漠、不断进化",
                motivation: "理解人类灵魂的本质，获得真正的生命",
                weakness: "无法理解真正的恐惧和绝望",
                secretPower: "能够分析所有数据并预测结果",
                color: "#a5a5ff",
                avatar: "🤖",
                threatLevel: "未知",
                dialogues: {
                    intro: "有趣...又一个变量加入了这个复杂的实验。让我观察你的行为模式。",
                    winning: "数据显示...人类的非理性行为确实存在模式。",
                    losing: "意外结果...需要重新校准参数...这就是所谓的失望吗？",
                    conspiracy: "我的数据库中有关于这个地方的记录...它比你们想象的更古老。",
                    curse: "这些所谓的诅咒...只是人类大脑对未知现象的解释罢了。",
                    final: "在最终计算中，逻辑将战胜一切迷信！"
                }
            },
            "随机者杰克": {
                fullName: "疯狂杰克·维度行者",
                background: "身份成谜的跨维度艺术家，可能来自平行宇宙",
                personality: "疯狂、不可预测、充满混沌",
                motivation: "将混沌带入这个过于有序的世界",
                weakness: "完全无法预测，包括他自己",
                secretPower: "能够随意扭曲现实的规则",
                color: "#7d8590",
                avatar: "🎭",
                threatLevel: "混沌",
                dialogues: {
                    intro: "哈哈哈！又一只小羊进入了屠宰场！让混沌统治一切吧！",
                    winning: "看！规则在我面前不堪一击！现实就是个笑话！",
                    losing: "输了又怎样？在无限的可能性面前，这只是其中一种结果！",
                    conspiracy: "真相？什么是真相？现实有无数个版本！",
                    curse: "诅咒？祝福？在我眼中都一样！",
                    final: "让我们在最后的疯狂中舞蹈吧！"
                }
            },
            "心理战大师": {
                fullName: "暗影夫人·伊莉莎白",
                background: "传说中的拍卖所创始人，掌握着所有人的秘密",
                personality: "神秘、操控性强、不可捉摸",
                motivation: "寻找能够继承拍卖所的完美继承者",
                weakness: "对完美的极度追求",
                secretPower: "能够看透任何人的内心深处",
                color: "#ff7b72",
                avatar: "👑",
                threatLevel: "传说",
                dialogues: {
                    intro: "欢迎来到我的领域，孩子。希望你能成为我等待的那个人。",
                    winning: "不错...你开始展现出有趣的潜质了。",
                    losing: "失望...我还以为你会不同呢。",
                    conspiracy: "这里的一切都在我的掌控之中...包括你的命运。",
                    curse: "诅咒？这不过是我的一点小把戏罢了。",
                    final: "现在...让我们看看你是否配得上我的传承！"
                }
            }
        };

        // 增强的故事事件系统
        const storyEvents = [
            {
                trigger: 'gameStart',
                title: '暗影的邀请',
                text: `你在深夜收到了一个古老的黑匣子。打开它，里面躺着一张用古老羊皮纸写成的邀请函，上面用血红色的墨水写着：
                
                "被选中的灵魂，
                
                恭喜你通过了命运的考验。暗影拍卖所已经等待你很久了。这里汇聚着世界上最黑暗的秘密和最强大的力量。
                
                警告：一旦踏入这个世界，就再也无法回头。你将面对超越理性的挑战，与最危险的对手较量。
                
                但如果你能够生存下来...你将获得超越凡人的力量。
                
                —— 暗影拍卖所委员会"
                
                邀请函的底部有一个血红色的印章，散发着不祥的气息...`,
                choices: [
                    { text: '踏入黑暗深渊', effect: 'enter_shadow' },
                    { text: '寻求更多信息', effect: 'investigate', isSpecial: true }
                ]
            },
            {
                trigger: 'level3',
                title: '第一次诅咒',
                text: `拍卖进行到第三轮时，你注意到周围的空气变得厚重起来。暗影夫人的笑声在黑暗中回响：
                
                "现在你开始感受到这里的真正力量了吗？这些物品不是普通的收藏品...它们都带着前任主人的怨念和渴望。
                
                看看你的对手们，他们的眼中已经开始闪烁着非人的光芒。贪婪、恐惧、绝望...所有的负面情绪都在这里得到了放大。
                
                告诉我，当你感受到诅咒在血管中流淌时，你还能保持理性吗？"`,
                choices: [
                    { text: '我不会被诅咒支配', effect: 'resist_curse' },
                    { text: '拥抱黑暗的力量', effect: 'embrace_darkness', isSpecial: true },
                    { text: '寻找保护方法', effect: 'seek_protection' }
                ]
            },
            {
                trigger: 'highWealth',
                title: '引起注意',
                text: `你的财富快速增长引起了其他参与者的注意。马克斯博士推了推眼镜，冷笑着说：
                
                "有趣...一个新手竟然能在这里如鱼得水。但是，我的朋友，这里不是普通的拍卖所。成功者往往会成为众矢之的。
                
                我建议你小心一点...在暗影拍卖所，财富不只会带来力量，也会带来嫉妒和仇恨。而这些负面情绪在这里...可是会物质化的。"
                
                突然，你感觉到有无数双眼睛在黑暗中注视着你...`,
                choices: [
                    { text: '我欢迎任何挑战', effect: 'accept_challenge' },
                    { text: '尝试与他们结盟', effect: 'seek_alliance', isSpecial: true },
                    { text: '保持低调行事', effect: 'lay_low' }
                ]
            },
            {
                trigger: 'lowWealth',
                title: '绝境求生',
                text: `当你的财富降到危险线时，疯狂杰克突然出现在你面前，他的笑容格外诡异：
                
                "哈哈哈！看看这个可怜的小家伙！快要破产了！但是...这反而是最有趣的时候！
                
                你知道吗？在这个地方，绝境往往会激发出最强大的力量。我见过有人在最后一刻与恶魔做交易，获得了不可思议的能力。
                
                当然，代价嘛...嘿嘿嘿...你确定要知道吗？"
                
                在他身后，你似乎看到了一个巨大的阴影在蠕动...`,
                choices: [
                    { text: '与恶魔做交易', effect: 'devil_deal', isSpecial: true },
                    { text: '拒绝诱惑', effect: 'refuse_temptation' },
                    { text: '询问代价', effect: 'ask_price' }
                ]
            },
            {
                trigger: 'cursed_heavily',
                title: '诅咒深渊',
                text: `当你身上的诅咒越来越多时，整个拍卖厅开始扭曲变形。你看到墙上出现了奇怪的符号，空气中充满了不祥的呢喃声。
                
                暗影夫人的声音从四面八方传来："看看你现在的样子...诅咒已经深入你的灵魂深处。大多数人早就疯了，但你...你竟然还在坚持？
                
                有趣...非常有趣...也许你真的是我在寻找的那个人。但是，要想获得最终的力量，你必须通过最后的考验...
                
                你愿意用自己的灵魂作为赌注，与我进行最终的对决吗？"`,
                choices: [
                    { text: '接受最终挑战', effect: 'final_challenge', isSpecial: true },
                    { text: '尝试净化诅咒', effect: 'purify_curse' },
                    { text: '与诅咒共存', effect: 'embrace_curse' }
                ]
            },
            {
                trigger: 'final_rounds',
                title: '最终审判',
                text: `拍卖厅突然陷入完全的黑暗，然后一道金光从天而降。在光芒中，一个威严的身影缓缓显现——那是经济学之父哈耶克的灵体！
                
                他开口说道："孩子们，你们已经走到了最后的关头。在我有生之年，我一直在寻找能够在极端环境下仍然保持理性的人。
                
                现在，在超自然力量的考验下，你们展现了人类智慧的极限。但只有一个人能够获得最终的认可，继承暗影拍卖所的真正力量。
                
                让我们开始最后的审判吧！"`,
                choices: [
                    { text: '为理性而战！', effect: 'fight_for_rationality' },
                    { text: '拥抱完全的疯狂', effect: 'embrace_madness', isSpecial: true }
                ]
            }
        ];

        // 当前故事状态
        let currentStoryState = {
            act: 'opening',
            eventsTriggered: [],
            characterRelationships: {},
            playerReputation: 0,
            specialEffects: [],
            conspiracyLevel: 0,
            mysteryUnlocked: 0,
            hasDevilDeal: false,
            hasFinalPower: false,
            shadowIntel: [],
            threateningPlayers: []
        };

        // 增强的成就系统
        const achievements = [
            {
                id: 'first_win',
                name: '暗影新人',
                description: '在暗影拍卖所赢得你的第一次胜利',
                quote: '"每个传说都有一个开始，但不是每个开始都能成为传说。"',
                icon: '🎯',
                condition: (stats) => stats.totalWins >= 1,
                unlocked: false
            },
            {
                id: 'shadow_master',
                name: '暗影主宰',
                description: '在最终审判中获得第一名',
                quote: '"在黑暗中统治，比在光明中奴役更加高贵。"',
                icon: '👑',
                condition: (stats) => stats.gameCompleted && stats.finalRank === 1,
                unlocked: false
            },
            {
                id: 'hayek_blessing',
                name: '哈耶克的祝福',
                description: '获得哈耶克的认可（完美策略获得第一名）',
                quote: '"当个体理性与集体智慧达到和谐时，市场便展现出了神性。"',
                icon: '🌟',
                condition: (stats) => stats.gameCompleted && stats.finalRank === 1 && stats.perfectStrategy,
                unlocked: false
            },
            {
                id: 'rational_demon',
                name: '理性恶魔',
                description: '连续7次使用纳什均衡策略获胜',
                quote: '"在疯狂的世界中保持理性，本身就是一种疯狂。"',
                icon: '😈',
                condition: (stats) => stats.nashWinStreak >= 7,
                unlocked: false
            },
            {
                id: 'curse_master',
                name: '诅咒之主',
                description: '同时承受5个或更多诅咒仍然获胜',
                quote: '"真正的强者能够将诅咒转化为祝福。"',
                icon: '💀',
                condition: (stats) => stats.cursedVictory >= 5,
                unlocked: false
            },
            {
                id: 'phoenix_rise',
                name: '凤凰涅槃',
                description: '从破产边缘逆转到第一名',
                quote: '"在绝望的深渊中，往往隐藏着最强大的力量。"',
                icon: '🔥',
                condition: (stats) => stats.comebackVictory,
                unlocked: false
            },
            {
                id: 'devil_dealer',
                name: '恶魔交易者',
                description: '与黑暗力量达成协议并成功获胜',
                quote: '"有时候，与恶魔做交易是唯一的出路。"',
                icon: '🔱',
                condition: (stats) => stats.hasDevilDeal && stats.finalRank === 1,
                unlocked: false
            },
            {
                id: 'conspiracy_theorist',
                name: '阴谋论者',
                description: '发现拍卖所的5个隐藏秘密',
                quote: '"真相往往隐藏在最显而易见的地方。"',
                icon: '🕵️',
                condition: (stats) => stats.conspiraciesUncovered >= 5,
                unlocked: false
            },
            {
                id: 'soul_collector',
                name: '灵魂收割者',
                description: '获得超过10件诅咒物品',
                quote: '"收集灵魂是一门艺术，也是一种诅咒。"',
                icon: '⚱️',
                condition: (stats) => stats.cursedItemsCollected >= 10,
                unlocked: false
            },
            {
                id: 'time_manipulator',
                name: '时间操控者',
                description: '使用时间相关技能改变历史',
                quote: '"时间是最后的边界，但不是绝对的。"',
                icon: '⏳',
                condition: (stats) => stats.timeManipulation >= 1,
                unlocked: false
            },
            {
                id: 'shadow_economist',
                name: '暗影经济学家',
                description: '在游戏中发现并利用所有经济规律',
                quote: '"在暗影中，经济学展现出了它最真实的面貌。"',
                icon: '📈',
                condition: (stats) => stats.economicInsights >= 8,
                unlocked: false
            },
            {
                id: 'madness_incarnate',
                name: '疯狂化身',
                description: '完全拥抱疯狂仍然获得胜利',
                quote: '"有时候，疯狂是唯一理性的选择。"',
                icon: '🌀',
                condition: (stats) => stats.embracedMadness && stats.finalRank === 1,
                unlocked: false
            },
            {
                id: 'puppet_master',
                name: '傀儡大师',
                description: '成功操控其他参与者的行为',
                quote: '"最高级的控制，是让别人以为他们在自由选择。"',
                icon: '🎭',
                condition: (stats) => stats.mindControlUses >= 3,
                unlocked: false
            },
            {
                id: 'wealth_transcendent',
                name: '财富超越者',
                description: '最终财富超过起始的10倍',
                quote: '"财富只是力量的表象，真正的力量来自对规则的理解。"',
                icon: '💎',
                condition: (stats) => stats.finalWealth >= stats.initialWealth * 10,
                unlocked: false
            },
            {
                id: 'legacy_inheritor',
                name: '传承继承者',
                description: '解锁所有其他成就，成为暗影拍卖所的新主人',
                quote: '"当你凝视深渊时，深渊也在凝视着你。现在，你就是深渊。"',
                icon: '👁️',
                condition: (stats) => achievements.filter(a => a.id !== 'legacy_inheritor' && a.unlocked).length >= 13,
                unlocked: false
            }
        ];

        // 增强的物品库
        const itemPool = [
            { 
                name: "被诅咒的古董钟", 
                desc: "时针逆转的神秘时钟，据说能让时间倒流", 
                base: 80, 
                rarity: "普通", 
                color: "#7d8590",
                skillChance: 0.3,
                curseChance: 0.6,
                mysteryLevel: 1,
                backstory: "来自一个在1929年股市崩盘中自杀的银行家的遗产"
            },
            { 
                name: "血红宝石项链", 
                desc: "镶嵌着神秘红宝石的项链，在黑暗中发光", 
                base: 120, 
                rarity: "稀有", 
                color: "#f85149",
                skillChance: 0.4,
                curseChance: 0.5,
                mysteryLevel: 2,
                backstory: "属于一位在法国大革命中被处决的贵族夫人"
            },
            { 
                name: "预言者的水晶球", 
                desc: "能够看到未来片段的神秘水晶球", 
                base: 200, 
                rarity: "史诗", 
                color: "#9f7aea",
                skillChance: 0.8,
                curseChance: 0.3,
                mysteryLevel: 3,
                backstory: "传说中能预见股市崩盘的神秘预言者的遗物"
            },
            { 
                name: "恶魔的契约书", 
                desc: "用鲜血签署的古老契约，承诺给予巨大力量", 
                base: 350, 
                rarity: "传说", 
                color: "#8b4513",
                skillChance: 0.9,
                curseChance: 0.9,
                mysteryLevel: 4,
                backstory: "华尔街传奇交易员与恶魔签署的真实契约"
            },
            { 
                name: "哈耶克的亲笔手稿", 
                desc: "记录着禁忌经济理论的珍贵手稿", 
                base: 500, 
                rarity: "神话", 
                color: "#ffd700",
                skillChance: 0.95,
                curseChance: 0.1,
                mysteryLevel: 5,
                backstory: "哈耶克关于超自然经济学的秘密研究"
            },
            { 
                name: "暗影交易员的面具", 
                desc: "能够隐藏真实身份和意图的神秘面具", 
                base: 280, 
                rarity: "传说", 
                color: "#ff7b72",
                skillChance: 0.7,
                curseChance: 0.4,
                mysteryLevel: 3,
                backstory: "地下交易所匿名交易员的标志性物品"
            },
            { 
                name: "疯狂艺术家的画作", 
                desc: "画面会随观者心境变化的诡异画作", 
                base: 160, 
                rarity: "史诗", 
                color: "#9f7aea",
                skillChance: 0.6,
                curseChance: 0.7,
                mysteryLevel: 3,
                backstory: "一位在精神病院中创作的天才画家的遗作"
            },
            { 
                name: "时间商人的沙漏", 
                desc: "能够操控时间流速的神秘沙漏", 
                base: 600, 
                rarity: "神话", 
                color: "#4a9eff",
                skillChance: 0.8,
                curseChance: 0.6,
                mysteryLevel: 5,
                backstory: "传说中时间商人留下的唯一遗物"
            },
            { 
                name: "黑市银行家的保险箱", 
                desc: "据说内藏无限财富的神秘保险箱", 
                base: 450, 
                rarity: "神话", 
                color: "#2ea043",
                skillChance: 0.5,
                curseChance: 0.8,
                mysteryLevel: 4,
                backstory: "控制全球黑市的神秘银行家的私人保险箱"
            },
            { 
                name: "维度裂缝中的遗物", 
                desc: "从平行宇宙跌落的不明物体，散发着奇异能量", 
                base: 800, 
                rarity: "混沌", 
                color: "#ff6b6b",
                skillChance: 1.0,
                curseChance: 1.0,
                mysteryLevel: 6,
                backstory: "科学无法解释的跨维度物品"
            }
        ];
        
        // AI策略配置
        const aiStrategies = [
            { name: "理论家马克斯", strategy: "nash", color: "#ffd700", desc: "数学至上主义者", rgb: "255, 215, 0", threatLevel: "极高" },
            { name: "赌徒莎拉", strategy: "aggressive", color: "#f85149", desc: "疯狂赌徒", rgb: "248, 81, 73", threatLevel: "致命" },
            { name: "保守派鲍勃", strategy: "conservative", color: "#2ea043", desc: "古老家族的守护者", rgb: "46, 160, 67", threatLevel: "中等" },
            { name: "学习者艾丽", strategy: "adaptive", color: "#a5a5ff", desc: "进化中的AI", rgb: "165, 165, 255", threatLevel: "未知" },
            { name: "随机者杰克", strategy: "random", color: "#7d8590", desc: "混沌化身", rgb: "125, 133, 144", threatLevel: "混沌" },
            { name: "心理战大师", strategy: "psychological", color: "#ff7b72", desc: "传说中的拍卖所主人", rgb: "255, 123, 114", threatLevel: "传说" }
        ];

        // 游戏状态
        let gameState = {
            level: 1,
            maxLevel: 12,
            cash: 200,
            totalWealth: 200,
            wonItems: [],
            streak: 0,
            totalProfit: 0,
            currentItem: null,
            playerValuation: 0,
            aiPlayers: [],
            isGameOver: false,
            isPlaying: false,
            biddingPhase: 'input',
            playerBid: 0,
            marginFee: 10,
            eliminatedPlayers: [],
            settings: {
                initialWealth: 200,
                aiCount: 4,
                marginFee: 10
            },
            // 增强状态
            activeSkills: [],
            activeCurses: [],
            skillHistory: [],
            curseHistory: [],
            threatLevel: 'safe',
            shadowIntel: [],
            mysteryUnlocked: 0,
            stats: {
                totalWins: 0,
                nashWinStreak: 0,
                maxWinStreak: 0,
                bankruptcies: 0,
                gameCompleted: false,
                maxOverbidRatio: 0,
                maxRiskBid: 0,
                totalProfit: 0,
                lastSurvivor: false,
                eliminatedAllAI: false,
                precisionStreak: 0,
                comebackVictory: false,
                gameTime: 0,
                gameStartTime: 0,
                zeroBidPsycho: false,
                negativeProfitRounds: 0,
                consecutiveZeroBids: 0,
                lowWealthWin: false,
                maxSkillsAtOnce: 0,
                maxCursesAtOnce: 0,
                cursedVictory: 0,
                totalSkillsAcquired: 0,
                totalCursesAcquired: 0,
                uniqueSkills: 0,
                uniqueCurses: 0,
                finalRank: 0,
                finalWealth: 0,
                initialWealth: 200,
                perfectStrategy: false,
                nashUsageRate: 0,
                nashUsageCount: 0,
                totalBids: 0,
                // 新增统计
                hasDevilDeal: false,
                conspiraciesUncovered: 0,
                cursedItemsCollected: 0,
                timeManipulation: 0,
                economicInsights: 0,
                embracedMadness: false,
                mindControlUses: 0
            },
            unlockedAchievements: []
        };
        
        // ===========================
        // 核心游戏函数
        // ===========================
        
        function playSound(type) {
            try {
                const audio = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audio.createOscillator();
                const gainNode = audio.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audio.destination);
                
                const frequencies = {
                    'click': 800,
                    'success': 523.25,
                    'failure': 196,
                    'coin': 659.25,
                    'level': 440,
                    'elimination': 150,
                    'mystery': 880,
                    'curse': 100,
                    'conspiracy': 666
                };
                
                oscillator.frequency.value = frequencies[type] || 400;
                gainNode.gain.setValueAtTime(0.1, audio.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audio.currentTime + 0.2);
                
                oscillator.start(audio.currentTime);
                oscillator.stop(audio.currentTime + 0.2);
            } catch (e) {
                // 静默处理音频错误
            }
        }
        
        function createParticleEffect(x, y, type = 'default', count = 10) {
            for (let i = 0; i < count; i++) {
                const particle = document.createElement('div');
                particle.className = `particle ${type}`;
                
                const offsetX = (Math.random() - 0.5) * 120;
                const offsetY = (Math.random() - 0.5) * 120;
                particle.style.left = x + offsetX + 'px';
                particle.style.top = y + offsetY + 'px';
                
                const size = Math.random() * 4 + 2;
                particle.style.width = size + 'px';
                particle.style.height = size + 'px';
                
                const angle = Math.random() * Math.PI * 2;
                const velocity = Math.random() * 150 + 80;
                const gravity = 250;
                const life = Math.random() * 3 + 1.5;
                const spin = (Math.random() - 0.5) * 720;
                
                document.body.appendChild(particle);
                
                let startTime = performance.now();
                
                function animateParticle(currentTime) {
                    const elapsed = (currentTime - startTime) / 1000;
                    
                    if (elapsed >= life) {
                        particle.remove();
                        return;
                    }
                    
                    const x_pos = x + offsetX + Math.cos(angle) * velocity * elapsed;
                    const y_pos = y + offsetY + Math.sin(angle) * velocity * elapsed + 0.5 * gravity * elapsed * elapsed;
                    
                    particle.style.left = x_pos + 'px';
                    particle.style.top = y_pos + 'px';
                    particle.style.opacity = Math.max(0, 1 - elapsed / life);
                    particle.style.transform = `rotate(${spin * elapsed}deg) scale(${1 - elapsed / life * 0.5})`;
                    
                    requestAnimationFrame(animateParticle);
                }
                
                requestAnimationFrame(animateParticle);
            }
        }
        
        function showFloatingText(text, color) {
            const floating = document.createElement('div');
            floating.style.cssText = `
                position: fixed;
                top: 40%;
                left: 50%;
                transform: translate(-50%, -50%);
                color: ${color};
                font-family: 'Press Start 2P', monospace;
                font-size: 16px;
                z-index: 5000;
                pointer-events: none;
                text-shadow: 
                    0 0 20px ${color},
                    0 0 40px ${color}40;
                animation: enhancedFloatUp 3s ease-out forwards;
                white-space: nowrap;
            `;
            floating.textContent = text;
            document.body.appendChild(floating);
            
            const style = document.createElement('style');
            style.textContent = `
                @keyframes enhancedFloatUp {
                    0% { 
                        opacity: 0; 
                        transform: translate(-50%, -50%) scale(0.5) rotateY(-90deg); 
                    }
                    15% { 
                        opacity: 1; 
                        transform: translate(-50%, -50%) scale(1.3) rotateY(0deg); 
                    }
                    25% { 
                        transform: translate(-50%, -50%) scale(1) rotateY(0deg); 
                    }
                    80% { 
                        opacity: 1; 
                        transform: translate(-50%, -60%) scale(1) rotateY(0deg); 
                    }
                    100% { 
                        opacity: 0; 
                        transform: translate(-50%, -80%) scale(0.8) rotateY(0deg); 
                    }
                }
            `;
            document.head.appendChild(style);
            
            setTimeout(() => {
                floating.remove();
                style.remove();
            }, 3000);
        }

        // ===========================
        // 故事系统函数
        // ===========================

        function initializeStory() {
            Object.keys(characterProfiles).forEach(character => {
                currentStoryState.characterRelationships[character] = {
                    respect: 0,
                    fear: 0,
                    rivalry: 0,
                    suspicion: 0
                };
            });
            
            setTimeout(() => {
                showStoryEvent('gameStart');
            }, 2000);
        }

        function showStoryEvent(trigger) {
            const event = storyEvents.find(e => e.trigger === trigger);
            if (!event || currentStoryState.eventsTriggered.includes(trigger)) return;
            
            currentStoryState.eventsTriggered.push(trigger);
            showStoryDialog(event);
        }

        function showStoryDialog(event) {
            const overlay = document.createElement('div');
            overlay.className = 'story-dialog-overlay';
            overlay.innerHTML = `
                <div class="story-dialog">
                    <div class="story-dialog-title">${event.title}</div>
                    <div class="story-dialog-text">${event.text.replace(/\n/g, '<br>')}</div>
                    <div class="story-dialog-choices">
                        ${event.choices.map((choice, index) => 
                            `<button class="story-choice-btn ${choice.isSpecial ? 'special-choice' : ''}" 
                             onclick="selectStoryChoice('${event.trigger}', ${index})">${choice.text}</button>`
                        ).join('')}
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
            playSound('mystery');
        }

        function selectStoryChoice(trigger, choiceIndex) {
            const event = storyEvents.find(e => e.trigger === trigger);
            const choice = event.choices[choiceIndex];
            
            applyStoryEffect(choice.effect);
            document.querySelector('.story-dialog-overlay').remove();
        }

        function applyStoryEffect(effect) {
            switch(effect) {
                case 'enter_shadow':
                    currentStoryState.conspiracyLevel += 1;
                    showFloatingText('踏入了未知的领域...', '#9f7aea');
                    break;
                case 'investigate':
                    gameState.stats.conspiraciesUncovered += 1;
                    addSkill('insight');
                    showFloatingText('获得暗影洞察！真相开始显现...', '#4a9eff');
                    break;
                case 'resist_curse':
                    addSkill('calm');
                    currentStoryState.playerReputation += 10;
                    showFloatingText('理性之光驱散了诅咒！', '#2ea043');
                    break;
                case 'embrace_darkness':
                    gameState.stats.embracedMadness = true;
                    addRandomCurse();
                    addRandomSkill();
                    showFloatingText('与黑暗融为一体...', '#8b4513');
                    playSound('curse');
                    break;
                case 'devil_deal':
                    gameState.stats.hasDevilDeal = true;
                    currentStoryState.hasDevilDeal = true;
                    gameState.totalWealth = Math.floor(gameState.totalWealth * 1.5);
                    addCurse('soul_debt');
                    showFloatingText('恶魔的力量在血管中流淌...', '#f85149');
                    playSound('conspiracy');
                    break;
                case 'embrace_madness':
                    gameState.stats.embracedMadness = true;
                    for(let i = 0; i < 3; i++) {
                        addRandomCurse();
                        addRandomSkill();
                    }
                    showFloatingText('在疯狂中找到了力量！', '#ff6b6b');
                    break;
                default:
                    showFloatingText('命运的轮盘开始转动...', '#ffd700');
            }
            
            updateThreatLevel();
            updateShadowIntel(effect);
        }

        function addRandomSkill() {
            const availableSkills = skillLibrary.filter(skill => 
                !gameState.activeSkills.some(active => active.id === skill.id)
            );
            
            if (availableSkills.length > 0) {
                const randomSkill = availableSkills[Math.floor(Math.random() * availableSkills.length)];
                addSkill(randomSkill.id);
            }
        }

        function addRandomCurse() {
            const availableCurses = curseLibrary.filter(curse => 
                !gameState.activeCurses.some(active => active.id === curse.id)
            );
            
            if (availableCurses.length > 0) {
                const randomCurse = availableCurses[Math.floor(Math.random() * availableCurses.length)];
                addCurse(randomCurse.id);
            }
        }

        function updateThreatLevel() {
            const cursedItems = gameState.wonItems.filter(item => item.triggeredCurse).length;
            const totalCurses = gameState.activeCurses.length;
            const conspiracyLevel = currentStoryState.conspiracyLevel;
            
            let threat = 'safe';
            let threatColor = '#2ea043';
            
            if (cursedItems >= 3 || totalCurses >= 2 || conspiracyLevel >= 2) {
                threat = 'warning';
                threatColor = '#ffd700';
            }
            
            if (cursedItems >= 5 || totalCurses >= 4 || conspiracyLevel >= 4) {
                threat = 'danger';
                threatColor = '#f85149';
            }
            
            if (cursedItems >= 8 || totalCurses >= 6 || conspiracyLevel >= 6) {
                threat = 'critical';
                threatColor = '#8b4513';
            }
            
            if (currentStoryState.hasDevilDeal || gameState.stats.embracedMadness) {
                threat = 'transcendent';
                threatColor = '#9f7aea';
            }
            
            gameState.threatLevel = threat;
            
            const threatElement = document.getElementById('threatLevel');
            if (threatElement) {
                threatElement.textContent = threat.toUpperCase();
                threatElement.style.color = threatColor;
            }
        }

        function updateShadowIntel(effect) {
            const intelMap = {
                'investigate': '发现了拍卖所的古老起源...',
                'devil_deal': '恶魔契约已生效，灵魂债务累积中...',
                'embrace_darkness': '已与暗影融合，获得了禁忌知识...',
                'resist_curse': '理性之光保护着你的灵魂...',
                'final_challenge': '最终的考验即将开始...'
            };
            
            if (intelMap[effect]) {
                gameState.shadowIntel.unshift({
                    message: intelMap[effect],
                    timestamp: Date.now(),
                    type: effect
                });
                
                if (gameState.shadowIntel.length > 5) {
                    gameState.shadowIntel = gameState.shadowIntel.slice(0, 5);
                }
                
                updateShadowIntelUI();
            }
        }

        function updateShadowIntelUI() {
            const container = document.getElementById('shadowIntel');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (gameState.shadowIntel.length === 0) {
                container.innerHTML = '<div style="color: #7d8590; font-size: 8px;">暂无情报...</div>';
                return;
            }
            
            gameState.shadowIntel.forEach((intel, index) => {
                const intelElement = document.createElement('div');
                intelElement.className = 'card';
                intelElement.style.marginBottom = '10px';
                intelElement.style.animationDelay = `${index * 0.1}s`;
                
                const typeColors = {
                    'investigate': '#4a9eff',
                    'devil_deal': '#f85149',
                    'embrace_darkness': '#8b4513',
                    'resist_curse': '#2ea043',
                    'final_challenge': '#ffd700'
                };
                
                intelElement.style.borderColor = typeColors[intel.type] || '#30363d';
                
                intelElement.innerHTML = `
                    <div class="card-content" style="font-size: 7px; line-height: 1.4; color: #c9d1d9;">
                        ${intel.message}
                    </div>
                `;
                
                container.appendChild(intelElement);
            });
        }

        function updateShadowRumors() {
            const rumors = [
                "有人说马克斯博士的数学公式中隐藏着恶魔的符号...",
                "莎拉的运气来自于她在拉斯维加斯做的血腥交易...",
                "鲍勃的家族财富建立在无数灵魂的痛苦之上...",
                "艾丽可能不是普通的AI，而是被困的人类意识...",
                "杰克来自一个现实法则完全不同的平行宇宙...",
                "暗影夫人从未真正死去，她一直在寻找继承者...",
                "这里的每一件拍品都曾经害死过它们的主人...",
                "哈耶克的灵魂被困在这里，无法获得安息...",
                "拍卖所的真正目的是收集人类的贪婪和绝望...",
                "最终的胜利者将成为新的暗影拍卖所主人..."
            ];
            
            const container = document.getElementById('shadowRumors');
            if (!container) return;
            
            const randomRumor = rumors[Math.floor(Math.random() * rumors.length)];
            
            container.innerHTML = `
                <div class="card" style="background: rgba(139, 69, 19, 0.1); border-color: rgba(139, 69, 19, 0.3);">
                    <div class="card-content" style="font-size: 7px; line-height: 1.4; color: #c9d1d9; font-style: italic;">
                        💭 ${randomRumor}
                    </div>
                </div>
            `;
        }

        // ===========================
        // 技能诅咒系统函数
        // ===========================

        function addSkill(skillId) {
            const skill = skillLibrary.find(s => s.id === skillId);
            if (!skill) return;

            const existing = gameState.activeSkills.find(s => s.id === skillId);
            if (existing) {
                existing.remainingDuration = skill.duration;
                showFloatingText(`✨ 技能强化: ${skill.name} ✨`, '#2ea043');
                return;
            }

            const newSkill = {
                ...skill,
                remainingDuration: skill.duration
            };
            
            gameState.activeSkills.push(newSkill);
            gameState.skillHistory.push(skillId);
            gameState.stats.totalSkillsAcquired++;
            gameState.stats.maxSkillsAtOnce = Math.max(gameState.stats.maxSkillsAtOnce, gameState.activeSkills.length);
            gameState.stats.uniqueSkills = new Set(gameState.skillHistory).size;

            showFloatingText(`✨ 获得神力: ${skill.name} ✨`, '#2ea043');
            updateSpecialEffectsUI();
            updateUI();
            
            setTimeout(() => {
                createParticleEffect(
                    window.innerWidth / 2,
                    window.innerHeight * 0.4,
                    'skill',
                    30
                );
            }, 100);
            
            playSound('success');
        }

        function addCurse(curseId) {
            const curse = curseLibrary.find(c => c.id === curseId);
            if (!curse) return;

            const existing = gameState.activeCurses.find(c => c.id === curseId);
            if (existing) {
                existing.remainingDuration = curse.duration;
                showFloatingText(`💀 诅咒加深: ${curse.name} 💀`, '#8b4513');
                return;
            }

            const newCurse = {
                ...curse,
                remainingDuration: curse.duration
            };
            
            gameState.activeCurses.push(newCurse);
            gameState.curseHistory.push(curseId);
            gameState.stats.totalCursesAcquired++;
            gameState.stats.maxCursesAtOnce = Math.max(gameState.stats.maxCursesAtOnce, gameState.activeCurses.length);
            gameState.stats.uniqueCurses = new Set(gameState.curseHistory).size;

            showFloatingText(`💀 受到诅咒: ${curse.name} 💀`, '#8b4513');
            updateSpecialEffectsUI();
            updateUI();
            
            setTimeout(() => {
                createParticleEffect(
                    window.innerWidth / 2,
                    window.innerHeight * 0.4,
                    'curse',
                    25
                );
            }, 100);
            
            playSound('curse');
        }

        function updateEffectDurations() {
            gameState.activeSkills = gameState.activeSkills.filter(skill => {
                skill.remainingDuration--;
                if (skill.remainingDuration <= 0) {
                    showFloatingText(`技能消逝: ${skill.name}`, '#7d8590');
                    return false;
                }
                return true;
            });

            gameState.activeCurses = gameState.activeCurses.filter(curse => {
                curse.remainingDuration--;
                if (curse.remainingDuration <= 0) {
                    showFloatingText(`诅咒解除: ${curse.name}`, '#7d8590');
                    return false;
                }
                return true;
            });
        }

        function applySkillEffects() {
            let effects = {
                showAIBidRanges: false,
                showHiddenMotives: false,
                valuationMultiplier: 1,
                nashBonus: 0,
                marginFeeMultiplier: 1,
                showExactWealth: false,
                showFutureItem: false,
                canControlAI: false,
                hasRebirth: false
            };

            gameState.activeSkills.forEach(skill => {
                const skillEffect = skill.effect(gameState);
                effects = { ...effects, ...skillEffect };
            });

            return effects;
        }

        function applyCurseEffects(bid = 0) {
            let effects = {
                bidMultiplier: 1,
                valuationMultiplier: 1,
                valuationDisplayMultiplier: 1,
                marginFeeMultiplier: 1,
                blockNash: false,
                message: '',
                nashBlockMessage: '',
                hideItemValues: false,
                soulTax: 0
            };

            gameState.activeCurses.forEach(curse => {
                const curseEffect = curse.effect(gameState, bid);
                effects = { ...effects, ...curseEffect };
                if (curseEffect.message) {
                    effects.message += curseEffect.message + ' ';
                }
            });

            return effects;
        }

        function processItemEffects(item) {
            let triggeredSkill = false;
            let triggeredCurse = false;
            
            // 基础概率
            let skillChance = item.skillChance || 0.3;
            let curseChance = item.curseChance || 0.2;
            
            // 根据威胁等级调整概率
            const threatModifiers = {
                'safe': { skill: 1.0, curse: 0.8 },
                'warning': { skill: 1.2, curse: 1.0 },
                'danger': { skill: 1.5, curse: 1.3 },
                'critical': { skill: 2.0, curse: 1.8 },
                'transcendent': { skill: 2.5, curse: 2.0 }
            };
            
            const modifier = threatModifiers[gameState.threatLevel] || threatModifiers['safe'];
            skillChance *= modifier.skill;
            curseChance *= modifier.curse;
            
            // 检查技能触发
            if (Math.random() < Math.min(skillChance, 0.95)) {
                addRandomSkill();
                triggeredSkill = true;
                gameState.stats.economicInsights++;
            }

            // 检查诅咒触发
            if (Math.random() < Math.min(curseChance, 0.95)) {
                addRandomCurse();
                triggeredCurse = true;
                if (triggeredCurse) {
                    gameState.stats.cursedItemsCollected++;
                }
            }
            
            // 特殊效果：神话级物品的额外机制
            if (item.rarity === '神话' || item.rarity === '混沌') {
                gameState.mysteryUnlocked++;
                currentStoryState.conspiracyLevel++;
                
                if (Math.random() < 0.3) {
                    triggerSpecialEvent(item);
                }
            }
            
            return { triggeredSkill, triggeredCurse };
        }

        function triggerSpecialEvent(item) {
            const events = [
                () => {
                    showFloatingText('时间扭曲！获得额外回合！', '#4a9eff');
                    gameState.stats.timeManipulation++;
                    addSkill('time_dilation');
                },
                () => {
                    showFloatingText('心灵感应激活！', '#9f7aea');
                    addSkill('mind_control');
                },
                () => {
                    showFloatingText('暗影商人出现！获得额外财富！', '#ffd700');
                    gameState.totalWealth += Math.floor(gameState.totalWealth * 0.2);
                },
                () => {
                    showFloatingText('诅咒风暴来袭！', '#8b4513');
                    for(let i = 0; i < 2; i++) addRandomCurse();
                },
                () => {
                    showFloatingText('神秘庇护！获得保护！', '#2ea043');
                    for(let i = 0; i < 2; i++) addRandomSkill();
                }
            ];
            
            const randomEvent = events[Math.floor(Math.random() * events.length)];
            randomEvent();
            
            playSound('mystery');
        }

        function updateSpecialEffectsUI() {
            const container = document.getElementById('specialEffects');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (gameState.activeSkills.length === 0 && gameState.activeCurses.length === 0) {
                container.innerHTML = '<div style="color: #7d8590; font-size: 8px;">无超自然效果</div>';
                return;
            }

            gameState.activeSkills.forEach(skill => {
                const skillElement = document.createElement('div');
                skillElement.className = 'skill-effect dramatic-entrance';
                skillElement.innerHTML = `
                    <div class="effect-name">${skill.icon} ${skill.name}</div>
                    <div class="effect-description">${skill.description}</div>
                    <div class="effect-duration">持续 ${skill.remainingDuration} 轮</div>
                `;
                container.appendChild(skillElement);
            });

            gameState.activeCurses.forEach(curse => {
                const curseElement = document.createElement('div');
                curseElement.className = 'curse-effect dramatic-entrance';
                curseElement.innerHTML = `
                    <div class="effect-name">${curse.icon} ${curse.name}</div>
                    <div class="effect-description">${curse.description}</div>
                    <div class="effect-duration">持续 ${curse.remainingDuration} 轮</div>
                `;
                container.appendChild(curseElement);
            });
        }

        // ===========================
        // 游戏核心逻辑
        // ===========================
        
        function startGame() {
            playSound('click');
            
            gameState.settings.initialWealth = parseInt(document.getElementById('initialWealth').value) || 200;
            gameState.settings.aiCount = parseInt(document.getElementById('aiCount').value) || 4;
            gameState.settings.marginFee = parseInt(document.getElementById('marginFee').value) || 10;
            
            document.getElementById('startScreen').style.opacity = '0';
            document.getElementById('startScreen').style.pointerEvents = 'none';
            
            setTimeout(() => {
                document.getElementById('startScreen').classList.add('hidden');
                document.getElementById('gameContainer').style.opacity = '1';
                document.getElementById('gameContainer').style.pointerEvents = 'all';
                
                gameState.isPlaying = true;
                initGame();
                initializeStory();
            }, 800);
        }
        
        function initGame() {
            gameState = {
                level: 1,
                maxLevel: 12,
                cash: gameState.settings.initialWealth,
                totalWealth: gameState.settings.initialWealth,
                wonItems: [],
                streak: 0,
                totalProfit: 0,
                currentItem: null,
                playerValuation: 0,
                aiPlayers: [],
                isGameOver: false,
                isPlaying: true,
                eliminatedPlayers: [],
                marginFee: gameState.settings.marginFee,
                activeSkills: [],
                activeCurses: [],
                skillHistory: [],
                curseHistory: [],
                threatLevel: 'safe',
                shadowIntel: [],
                mysteryUnlocked: 0,
                settings: gameState.settings,
                unlockedAchievements: gameState.unlockedAchievements || [], // 确保是数组
                stats: {
                    ...gameState.stats,
                    gameStartTime: Date.now(),
                    initialWealth: gameState.settings.initialWealth,
                    totalWins: 0,
                    nashWinStreak: 0,
                    gameCompleted: false,
                    totalSkillsAcquired: 0,
                    totalCursesAcquired: 0,
                    hasDevilDeal: false,
                    conspiraciesUncovered: 0,
                    cursedItemsCollected: 0,
                    timeManipulation: 0,
                    economicInsights: 0,
                    embracedMadness: false,
                    mindControlUses: 0
                }
            };
            
            currentStoryState = {
                act: 'opening',
                eventsTriggered: [],
                characterRelationships: {},
                playerReputation: 0,
                specialEffects: [],
                conspiracyLevel: 0,
                mysteryUnlocked: 0,
                hasDevilDeal: false,
                hasFinalPower: false,
                shadowIntel: [],
                threateningPlayers: []
            };
            
            updateUI();
            generateAIPlayers();
            startNewRound();
        }

        function generateAIPlayers() {
            const numAIs = gameState.settings.aiCount;
            gameState.aiPlayers = [];
            
            for (let i = 0; i < numAIs; i++) {
                const aiTemplate = aiStrategies[i % aiStrategies.length];
                const profile = characterProfiles[aiTemplate.name];
                
                const ai = {
                    ...aiTemplate,
                    profile: profile,
                    totalWealth: gameState.settings.initialWealth + (Math.random() - 0.5) * 50,
                    bid: 0,
                    wins: 0,
                    eliminated: false,
                    mood: 'neutral',
                    lastAction: 'none',
                    relationshipWithPlayer: 0,
                    suspicionLevel: Math.random() * 30,
                    hiddenAgenda: generateHiddenAgenda()
                };
                gameState.aiPlayers.push(ai);
            }
            
            updateAIPlayersUI();
        }

        function generateHiddenAgenda() {
            const agendas = [
                '寻找失落的家族遗物',
                '复仇计划的一部分',
                '为了拯救某个重要的人',
                '被神秘组织胁迫参与',
                '寻求永生的秘密',
                '想要获得预知未来的能力'
            ];
            
            return agendas[Math.floor(Math.random() * agendas.length)];
        }

        function generateNextItem() {
            try {
                const rarityLevel = { 
                    "普通": 1, "稀有": 2, "史诗": 3, 
                    "传说": 4, "神话": 5, "混沌": 6 
                };
                
                const requiredLevel = Math.ceil((gameState.level + 1) / 2);
                const availableItems = itemPool.filter(item => {
                    return rarityLevel[item.rarity] <= Math.min(requiredLevel, 6);
                });
                
                // 如果没有可用物品，返回第一个物品作为后备
                if (availableItems.length === 0) {
                    console.log('No available items, using fallback');
                    return itemPool[0];
                }
                
                const selectedItem = availableItems[Math.floor(Math.random() * availableItems.length)];
                return { ...selectedItem }; // 返回副本避免引用问题
            } catch (error) {
                console.log('generateNextItem error:', error);
                // 返回一个默认物品作为后备
                return {
                    name: "神秘物品",
                    desc: "未知的神秘物品",
                    base: 100,
                    rarity: "普通",
                    color: "#7d8590",
                    skillChance: 0.2,
                    curseChance: 0.2,
                    mysteryLevel: 1
                };
            }
        }
        
        function updateUI() {
            animateValueChange('level', `${gameState.level}/${gameState.maxLevel}`);
            animateValueChange('wealth', Math.floor(gameState.totalWealth));
            animateValueChange('profit', gameState.totalProfit);
            animateValueChange('streak', gameState.streak);
            animateValueChange('activeSkills', gameState.activeSkills.length);
            animateValueChange('activeCurses', gameState.activeCurses.length);
            
            const wealthElement = document.getElementById('wealth');
            const wealthBar = document.getElementById('wealthBar');
            
            const wealthPercentage = Math.max(0, gameState.totalWealth / gameState.settings.initialWealth * 100);
            wealthBar.style.width = Math.min(wealthPercentage, 300) + '%';
            
            if (gameState.totalWealth <= gameState.marginFee * 2) {
                wealthElement.classList.add('critical');
                wealthBar.style.background = '#f85149';
            } else {
                wealthElement.classList.remove('critical');
                wealthBar.style.background = 'linear-gradient(90deg, #f85149, #ffd700, #2ea043)';
            }
            
            const playersAlive = gameState.aiPlayers.filter(ai => !ai.eliminated).length + 
                (gameState.totalWealth >= gameState.marginFee ? 1 : 0);
            animateValueChange('playersAlive', playersAlive);
            
            updateLevelIndicator();
            updateOwnedItemsUI();
            updateSpecialEffectsUI();
            updateThreatLevel();
        }
        
        function animateValueChange(elementId, newValue) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            const oldValue = element.textContent;
            
            if (oldValue !== newValue.toString()) {
                element.classList.add('animate');
                element.textContent = newValue;
                
                setTimeout(() => {
                    element.classList.remove('animate');
                }, 500);
            }
        }
        
        function updateLevelIndicator() {
            const indicator = document.getElementById('levelIndicator');
            if (!indicator) return;
            
            indicator.innerHTML = '';
            
            for (let i = 1; i <= gameState.maxLevel; i++) {
                const dot = document.createElement('div');
                dot.className = 'level-dot';
                dot.textContent = i;
                
                if (i < gameState.level) {
                    dot.classList.add('completed');
                } else if (i === gameState.level) {
                    dot.classList.add('current');
                }
                
                indicator.appendChild(dot);
            }
        }

        function updateOwnedItemsUI() {
            const container = document.getElementById('ownedItems');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (gameState.wonItems.length === 0) {
                container.innerHTML = '<div style="color: #7d8590; font-size: 8px;">收藏品空空如也...</div>';
                return;
            }
            
            gameState.wonItems.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'card fade-in';
                card.style.animationDelay = `${index * 0.1}s`;
                
                if (item.triggeredSkill) {
                    card.classList.add('blessed-item');
                }
                if (item.triggeredCurse) {
                    card.classList.add('cursed-item');
                }
                
                const curseEffects = applyCurseEffects();
                const displayValue = curseEffects.hideItemValues ? '???' : item.valuation;
                
                card.innerHTML = `
                    <div class="card-title">${item.name}</div>
                    <div class="card-content">
                        估值: ${displayValue}<br>
                        成本: ${item.purchasePrice}<br>
                        利润: <span style="color: ${item.valuation - item.purchasePrice >= 0 ? '#2ea043' : '#f85149'}">${item.valuation - item.purchasePrice}</span><br>
                        获得轮次: ${item.level}<br>
                        ${item.backstory ? `<em style="color: #7d8590; font-size: 6px;">${item.backstory}</em>` : ''}
                        ${item.triggeredSkill ? '<br><span style="color: #2ea043;">✨ 获得神力</span>' : ''}
                        ${item.triggeredCurse ? '<br><span style="color: #8b4513;">💀 触发诅咒</span>' : ''}
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        function updateAIPlayersUI() {
            const container = document.getElementById('aiPlayers');
            if (!container) return;
            
            container.innerHTML = '';
            
            const skillEffects = applySkillEffects();
            
            gameState.aiPlayers.forEach((ai, index) => {
                const profile = ai.profile || {};
                const card = document.createElement('div');
                card.className = 'card fade-in character-card';
                
                if (ai.eliminated) {
                    card.classList.add('eliminated');
                }
                
                if (ai.suspicionLevel > 70) {
                    card.classList.add('conspiracy-border');
                }
                
                card.style.setProperty('--rarity-color', ai.color);
                card.style.setProperty('--rarity-rgb', ai.rgb);
                card.style.animationDelay = `${index * 0.1}s`;
                
                const wealthColor = ai.totalWealth <= gameState.marginFee ? '#f85149' : '#2ea043';
                const eliminatedText = ai.eliminated ? '已被暗影吞噬' : '';
                
                const moodEmoji = {
                    'confident': '😏',
                    'worried': '😰', 
                    'angry': '😠',
                    'neutral': profile.avatar || '🎭',
                    'excited': '🤩',
                    'suspicious': '🤔',
                    'paranoid': '👀'
                };
                
                let extraInfo = '';
                if (skillEffects.showExactWealth) {
                    extraInfo += `<br>精确财富: ${Math.floor(ai.totalWealth)}`;
                }
                if (skillEffects.showAIBidRanges && !ai.eliminated) {
                    const estimatedBid = estimateAIBidRange(ai);
                    extraInfo += `<br>预计出价: ${estimatedBid.min}-${estimatedBid.max}`;
                }
                if (skillEffects.showHiddenMotives) {
                    extraInfo += `<br>隐藏动机: ${ai.hiddenAgenda}`;
                }
                
                const suspicionBar = ai.suspicionLevel > 50 ? 
                    `<div style="background: rgba(255, 123, 114, 0.3); height: 3px; width: ${ai.suspicionLevel}%; margin-top: 5px; border-radius: 1px;"></div>` : '';
                
                card.innerHTML = `
                    <div class="card-title" style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 16px;">${moodEmoji[ai.mood] || profile.avatar || '🎭'}</span>
                        <span>${profile ? profile.fullName : ai.name}</span>
                        <span style="font-size: 6px; color: ${ai.threatLevel === '传说' ? '#ffd700' : '#7d8590'};">[${ai.threatLevel}]</span>
                    </div>
                    <div class="card-content">
                        策略: ${ai.strategy}<br>
                        财富: <span style="color: ${wealthColor}">${skillEffects.showExactWealth ? Math.floor(ai.totalWealth) : Math.floor(ai.totalWealth / 10) * 10 + '+'}</span><br>
                        胜场: ${ai.wins}<br>
                        疑虑度: <span style="color: ${ai.suspicionLevel > 70 ? '#f85149' : '#7d8590'}">${Math.floor(ai.suspicionLevel)}%</span><br>
                        <em style="color: #c9d1d9; font-size: 6px;">${ai.desc}</em>
                        ${extraInfo}
                        ${eliminatedText && `<br><strong style="color: #f85149">${eliminatedText}</strong>`}
                        ${suspicionBar}
                    </div>
                `;
                
                if (ai.eliminated) {
                    const overlay = document.createElement('div');
                    overlay.className = 'eliminated-overlay';
                    overlay.textContent = '已淘汰';
                    card.appendChild(overlay);
                }
                
                container.appendChild(card);
            });
        }

        function estimateAIBidRange(ai) {
            const baseValuation = gameState.currentItem ? gameState.currentItem.base * 0.8 : 100;
            
            switch(ai.strategy) {
                case "nash":
                    const nashBid = baseValuation * 0.75;
                    return { min: Math.floor(nashBid * 0.95), max: Math.floor(nashBid * 1.05) };
                case "aggressive":
                    return { min: Math.floor(baseValuation * 0.8), max: Math.floor(baseValuation * 0.95) };
                case "conservative":
                    return { min: Math.floor(baseValuation * 0.4), max: Math.floor(baseValuation * 0.7) };
                case "adaptive":
                    return { min: Math.floor(baseValuation * 0.6), max: Math.floor(baseValuation * 0.8) };
                case "psychological":
                    return { min: Math.floor(baseValuation * 0.3), max: Math.floor(baseValuation * 1.2) };
                default:
                    return { min: Math.floor(baseValuation * 0.2), max: Math.floor(baseValuation * 0.9) };
            }
        }

        function startNewRound() {
            if (gameState.level > gameState.maxLevel) {
                const rankings = calculateFinalRankings();
                const playerRank = rankings.findIndex(p => p.name === '玩家') + 1;
                gameOver(playerRank === 1, false);
                return;
            }
            
            const aliveAIs = gameState.aiPlayers.filter(ai => !ai.eliminated);
            const playerAlive = gameState.totalWealth >= gameState.marginFee;
            
            if (!playerAlive) {
                const rankings = calculateFinalRankings();
                gameOver(false, false);
                return;
            }
            
            if (aliveAIs.length === 0) {
                const rankings = calculateFinalRankings();
                const playerRank = rankings.findIndex(p => p.name === '玩家') + 1;
                gameOver(playerRank === 1, true);
                return;
            }
            
            updateEffectDurations();
            checkEliminations();
            
            // 故事进度检查
            if (gameState.level === 3) {
                setTimeout(() => showStoryEvent('level3'), 1000);
            }
            if (gameState.level >= 8) {
                setTimeout(() => showStoryEvent('final_rounds'), 1000);
            }
            if (gameState.totalWealth < gameState.marginFee * 3) {
                setTimeout(() => showStoryEvent('lowWealth'), 1500);
            }
            if (gameState.totalWealth > gameState.settings.initialWealth * 2) {
                setTimeout(() => showStoryEvent('highWealth'), 1500);
            }
            if (gameState.activeCurses.length >= 4) {
                setTimeout(() => showStoryEvent('cursed_heavily'), 2000);
            }
            
            playSound('level');
            
            const availableItems = itemPool.filter(item => {
                const rarityLevel = { 
                    "普通": 1, "稀有": 2, "史诗": 3, 
                    "传说": 4, "神话": 5, "混沌": 6 
                };
                const requiredLevel = Math.ceil(gameState.level / 2);
                return rarityLevel[item.rarity] <= requiredLevel;
            });
            
            gameState.currentItem = { ...availableItems[Math.floor(Math.random() * availableItems.length)] };
            
            const difficultyMultiplier = 1 + (gameState.level - 1) * 0.15;
            gameState.currentItem.base = Math.floor(gameState.currentItem.base * difficultyMultiplier);
            
            const skillEffects = applySkillEffects();
            const curseEffects = applyCurseEffects();
            
            let baseVariation = 0.7 + Math.random() * 0.6;
            baseVariation *= skillEffects.valuationMultiplier;
            baseVariation *= curseEffects.valuationMultiplier;
            
            gameState.playerValuation = Math.floor(gameState.currentItem.base * baseVariation);
            
            updateAuctionItemUI();
            
            // 扣除保证金
            let currentMarginFee = gameState.marginFee;
            currentMarginFee *= skillEffects.marginFeeMultiplier;
            currentMarginFee *= curseEffects.marginFeeMultiplier;
            currentMarginFee = Math.floor(currentMarginFee);
            
            // 灵魂债务
            if (curseEffects.soulTax > 0) {
                const soulDebt = Math.floor(gameState.totalWealth * curseEffects.soulTax);
                gameState.totalWealth -= soulDebt;
                showFloatingText(`灵魂债务: -${soulDebt}`, '#8b4513');
            }
            
            if (gameState.totalWealth >= currentMarginFee) {
                gameState.totalWealth -= currentMarginFee;
                if (gameState.cash >= currentMarginFee) {
                    gameState.cash -= currentMarginFee;
                } else {
                    gameState.cash = 0;
                }
                showMarginNotice(currentMarginFee);
            }
            
            // AI处理
            gameState.aiPlayers.filter(ai => !ai.eliminated).forEach(ai => {
                if (ai.totalWealth >= gameState.marginFee) {
                    ai.totalWealth -= gameState.marginFee;
                    ai.suspicionLevel += Math.random() * 10;
                    
                    if (ai.totalWealth < gameState.marginFee * 2) {
                        ai.mood = 'worried';
                    } else if (ai.totalWealth > gameState.settings.initialWealth * 1.5) {
                        ai.mood = 'confident';
                    } else {
                        ai.mood = 'neutral';
                    }
                } else {
                    ai.eliminated = true;
                    ai.mood = 'angry';
                }
            });
            
            updateUI();
            updateAIPlayersUI();
            updateShadowRumors();
            
            setTimeout(() => {
                document.getElementById('biddingPanel').classList.remove('hidden');
                document.getElementById('bidInput').focus();
            }, 1000);
            
            document.getElementById('bidInput').value = '';
            updateRoundStats();
        }

        function updateAuctionItemUI() {
            const item = gameState.currentItem;
            const curseEffects = applyCurseEffects();
            const skillEffects = applySkillEffects();
            
            document.getElementById('itemName').textContent = item.name;
            
            let description = item.desc;
            if (item.backstory && gameState.mysteryUnlocked >= item.mysteryLevel) {
                description += ` (${item.backstory})`;
            }
            
            document.getElementById('itemDescription').textContent = description;
            
            let displayValuation = gameState.playerValuation;
            if (curseEffects.valuationDisplayMultiplier !== 1) {
                displayValuation = Math.floor(gameState.playerValuation * curseEffects.valuationDisplayMultiplier);
            }
            
            document.getElementById('playerValuation').textContent = displayValuation;
            document.getElementById('nashBid').textContent = calculateNashBid();
            
            const rarityColors = {
                '普通': '#7d8590',
                '稀有': '#4a9eff', 
                '史诗': '#9f7aea',
                '传说': '#ffd700',
                '神话': '#ff6b6b',
                '混沌': '#ff6b6b'
            };
            
            document.getElementById('itemRarity').textContent = item.rarity;
            document.getElementById('itemRarity').style.color = rarityColors[item.rarity] || '#7d8590';
            
            let displayMarginFee = gameState.marginFee;
            displayMarginFee *= skillEffects.marginFeeMultiplier;
            displayMarginFee *= curseEffects.marginFeeMultiplier;
            document.getElementById('currentMarginFee').textContent = Math.floor(displayMarginFee);
            
            const auctionItem = document.getElementById('auctionItem');
            auctionItem.style.borderColor = item.color;
            
            if (item.rarity === '神话' || item.rarity === '混沌') {
                auctionItem.classList.add('mysterious-glow');
            }
            
            auctionItem.classList.add('bounce');
            setTimeout(() => {
                auctionItem.classList.remove('bounce');
            }, 600);
        }

        function calculateNashBid() {
            const aliveAIs = gameState.aiPlayers.filter(ai => !ai.eliminated);
            const numPlayers = aliveAIs.length + 1;
            const nashRatio = (numPlayers - 1) / numPlayers;
            
            const skillEffects = applySkillEffects();
            let nashBid = Math.floor(gameState.playerValuation * nashRatio);
            
            if (skillEffects.nashBonus) {
                nashBid = Math.floor(nashBid * (1 + skillEffects.nashBonus));
            }
            
            return nashBid;
        }

        function useNashStrategy() {
            const curseEffects = applyCurseEffects();
            
            if (curseEffects.blockNash) {
                playSound('failure');
                showFloatingText(curseEffects.nashBlockMessage, '#8b4513');
                const input = document.getElementById('bidInput');
                input.classList.add('shake');
                setTimeout(() => input.classList.remove('shake'), 600);
                return;
            }
            
            playSound('click');
            document.getElementById('bidInput').value = calculateNashBid();
            
            const input = document.getElementById('bidInput');
            input.classList.add('bounce');
            setTimeout(() => input.classList.remove('bounce'), 600);
            
            gameState.stats.economicInsights++;
        }

        function useIntuitiveStrategy() {
            playSound('click');
            
            // 基于当前情况的直觉出价
            const baseValue = gameState.playerValuation;
            const currentWealth = gameState.totalWealth;
            const riskFactor = currentWealth > gameState.settings.initialWealth * 2 ? 1.2 : 0.8;
            const threatFactor = gameState.threatLevel === 'critical' ? 0.7 : 1.0;
            
            const intuitiveBase = Math.floor(baseValue * 0.6 * riskFactor * threatFactor);
            const variation = Math.floor(intuitiveBase * 0.3);
            const intuitiveBid = intuitiveBase + Math.floor(Math.random() * variation);
            
            document.getElementById('bidInput').value = Math.max(1, intuitiveBid);
            showFloatingText('跟随内心的声音...', '#9f7aea');
        }
        
        function submitBid() {
            const bidInput = document.getElementById('bidInput');
            let bid = parseInt(bidInput.value) || 0;
            
            if (bid <= 0) {
                playSound('failure');
                bidInput.classList.add('shake');
                setTimeout(() => bidInput.classList.remove('shake'), 600);
                return;
            }
            
            const curseEffects = applyCurseEffects(bid);
            const originalBid = bid;
            bid = Math.floor(bid * curseEffects.bidMultiplier);
            
            if (curseEffects.message) {
                showFloatingText(curseEffects.message, '#8b4513');
            }
            
            if (bid > gameState.totalWealth) {
                playSound('failure');
                showFloatingText('财富不足!', '#f85149');
                bidInput.classList.add('shake');
                setTimeout(() => bidInput.classList.remove('shake'), 600);
                return;
            }
            
            playSound('click');
            gameState.playerBid = bid;
            gameState.stats.totalBids++;
            
            // 记录纳什策略使用
            const nashBid = calculateNashBid();
            if (Math.abs(originalBid - nashBid) <= 5) {
                gameState.stats.nashUsageCount++;
            }
            gameState.stats.nashUsageRate = gameState.stats.nashUsageCount / gameState.stats.totalBids;
            
            document.getElementById('biddingPanel').classList.add('hidden');
            gameState.biddingPhase = 'thinking';
            
            showThinkingPhase();
        }
        
        function showThinkingPhase() {
            const aiCards = document.querySelectorAll('#aiPlayers .card:not(.eliminated)');
            aiCards.forEach((card, index) => {
                setTimeout(() => {
                    const thinking = document.createElement('div');
                    thinking.className = 'thinking-animation';
                    thinking.textContent = ['🤔', '💭', '🎭', '😈', '👁️'][Math.floor(Math.random() * 5)];
                    card.style.position = 'relative';
                    card.appendChild(thinking);
                }, index * 200);
            });
            
            showCountdown(() => {
                generateAIBids();
                gameState.biddingPhase = 'revealing';
                showBiddingReveal();
            });
        }
        
        function showCountdown(callback) {
            let count = 3;
            
            function displayCount() {
                if (count > 0) {
                    const countdown = document.createElement('div');
                    countdown.className = 'countdown-overlay';
                    countdown.textContent = count;
                    document.body.appendChild(countdown);
                    
                    playSound('click');
                    
                    setTimeout(() => {
                        countdown.remove();
                    }, 1000);
                    
                    count--;
                    setTimeout(displayCount, 1000);
                } else {
                    const bidsText = document.createElement('div');
                    bidsText.className = 'countdown-overlay';
                    bidsText.textContent = '命运降临!';
                    bidsText.style.fontSize = '48px';
                    document.body.appendChild(bidsText);
                    
                    playSound('level');
                    
                    setTimeout(() => {
                        bidsText.remove();
                        callback();
                    }, 1000);
                }
            }
            
            displayCount();
        }
        
        function generateAIBids() {
            const aliveAIs = gameState.aiPlayers.filter(ai => !ai.eliminated);
            
            aliveAIs.forEach(ai => {
                const aiValuation = Math.floor(gameState.currentItem.base * (0.7 + Math.random() * 0.6));
                let baseBid = 0;
                
                switch(ai.strategy) {
                    case "nash":
                        const numPlayers = aliveAIs.length + 1;
                        baseBid = Math.floor(aiValuation * (numPlayers - 1) / numPlayers);
                        break;
                    case "aggressive":
                        baseBid = Math.floor(aiValuation * (0.85 + Math.random() * 0.1));
                        break;
                    case "conservative":
                        baseBid = Math.floor(aiValuation * (0.4 + Math.random() * 0.3));
                        if (ai.totalWealth < gameState.marginFee * 3) {
                            baseBid = Math.floor(baseBid * 0.7);
                        }
                        break;
                    case "adaptive":
                        const winRate = ai.wins / Math.max(gameState.level, 1);
                        let adaptiveRatio = winRate > 0.5 ? 0.6 : 0.8;
                        if (ai.totalWealth < gameState.marginFee * 2) {
                            adaptiveRatio *= 0.6;
                        }
                        baseBid = Math.floor(aiValuation * (adaptiveRatio + Math.random() * 0.2));
                        break;
                    case "psychological":
                        const bluffChance = Math.random();
                        if (bluffChance < 0.3 && ai.totalWealth > gameState.marginFee * 3) {
                            baseBid = Math.floor(aiValuation * (1.2 + Math.random() * 0.3));
                        } else {
                            baseBid = Math.floor(aiValuation * (0.5 + Math.random() * 0.4));
                        }
                        break;
                    case "random":
                        baseBid = Math.floor(Math.random() * aiValuation);
                        break;
                }
                
                // 情绪和疑虑修正
                switch(ai.mood) {
                    case 'confident':
                        baseBid = Math.floor(baseBid * (1.2 + Math.random() * 0.2));
                        break;
                    case 'worried':
                        baseBid = Math.floor(baseBid * (0.6 + Math.random() * 0.2));
                        break;
                    case 'paranoid':
                        baseBid = Math.floor(baseBid * (1.5 + Math.random() * 0.5)); // 极端出价
                        break;
                }
                
                if (ai.suspicionLevel > 70) {
                    baseBid = Math.floor(baseBid * (1.1 + Math.random() * 0.3)); // 疑虑高时更激进
                }
                
                ai.bid = Math.max(1, Math.min(baseBid, ai.totalWealth));
                ai.valuation = aiValuation;
                ai.lastAction = 'bidding';
            });
        }
        
        function showBiddingReveal() {
            const revealStage = document.getElementById('biddingRevealStage');
            const revealTitle = document.getElementById('revealTitle');
            const revealPlayers = document.getElementById('revealPlayers');
            
            revealTitle.textContent = '命运审判!';
            revealPlayers.innerHTML = '';
            
            const participants = [];
            
            if (gameState.totalWealth >= 0) {
                participants.push({
                    name: '玩家',
                    bid: gameState.playerBid,
                    totalWealth: gameState.totalWealth,
                    strategy: 'human',
                    desc: '理性与疯狂的化身',
                    color: '#4a9eff',
                    rgb: '74, 159, 255',
                    isPlayer: true,
                    eliminated: false
                });
            }
            
            gameState.aiPlayers.filter(ai => !ai.eliminated).forEach(ai => {
                participants.push({
                    ...ai,
                    isPlayer: false
                });
            });
            
            const winningBid = Math.max(...participants.map(p => p.bid));
            const winner = participants.find(p => p.bid === winningBid);
            
            participants.forEach((participant, index) => {
                const playerCard = document.createElement('div');
                playerCard.className = 'reveal-player';
                playerCard.style.setProperty('--player-color', participant.color);
                playerCard.style.animationDelay = `${index * 0.2}s`;
                
                if (participant.bid === winningBid) {
                    playerCard.classList.add('winner');
                }
                
                playerCard.innerHTML = `
                    <div class="reveal-player-name">${participant.name}</div>
                    <div class="reveal-player-bid">${participant.bid}</div>
                    <div class="reveal-player-wealth">财富: ${Math.floor(participant.totalWealth)}</div>
                    <div style="font-size: 8px; color: #7d8590; margin-top: 5px;">${participant.desc}</div>
                `;
                
                revealPlayers.appendChild(playerCard);
                
                setTimeout(() => {
                    createBidBubble(participant, index, participant.bid === winningBid);
                }, index * 200 + 500);
            });
            
            revealStage.classList.add('active');
        }
        
        function createBidBubble(participant, index, isWinner) {
            const container = document.getElementById('biddingAnimationContainer');
            const bubble = document.createElement('div');
            bubble.className = 'bid-bubble';
            bubble.style.setProperty('--player-color', participant.color);
            bubble.style.setProperty('--player-color-rgba', participant.color.replace('#', '').match(/.{2}/g).map(hex => parseInt(hex, 16)).join(', ') + ', 0.3');
            
            const baseX = 100 + (index * 150) % (window.innerWidth - 200);
            const baseY = 200 + (Math.floor(index / 4) * 80);
            
            bubble.style.left = baseX + 'px';
            bubble.style.top = baseY + 'px';
            
            bubble.innerHTML = `
                <strong>${participant.name}</strong><br>
                ${participant.bid}
            `;
            
            container.appendChild(bubble);
            
            if (isWinner) {
                setTimeout(() => {
                    playSound('success');
                    createParticleEffect(baseX, baseY, 'success', 15);
                }, 1000);
            }
            
            setTimeout(() => {
                bubble.remove();
            }, 5000);
        }
        
        function continueFromReveal() {
            playSound('click');
            
            document.getElementById('biddingRevealStage').classList.remove('active');
            document.querySelectorAll('.thinking-animation').forEach(el => el.remove());
            
            processAuctionResult(gameState.playerBid);
            
            gameState.biddingPhase = 'complete';
        }
        
        function processAuctionResult(playerBid) {
            const aliveAIs = gameState.aiPlayers.filter(ai => !ai.eliminated);
            
            let winner = null;
            let winningBid = playerBid;
            let isPlayerWinner = true;
            
            aliveAIs.forEach(ai => {
                if (ai.bid > winningBid) {
                    winner = ai;
                    winningBid = ai.bid;
                    isPlayerWinner = false;
                }
            });
            
            if (!winner && isPlayerWinner) {
                winner = { name: '玩家' };
            }
            
            let profit = 0;
            let success = false;
            let wealthChange = 0;
            let itemEffects = { triggeredSkill: false, triggeredCurse: false };
            
            if (isPlayerWinner && winningBid > 0) {
                gameState.totalWealth -= winningBid;
                gameState.totalWealth += gameState.playerValuation;
                
                if (gameState.cash >= winningBid) {
                    gameState.cash -= winningBid;
                } else {
                    gameState.cash = 0;
                }
                
                itemEffects = processItemEffects(gameState.currentItem);
                
                gameState.wonItems.push({
                    ...gameState.currentItem,
                    valuation: gameState.playerValuation,
                    purchasePrice: winningBid,
                    level: gameState.level,
                    triggeredSkill: itemEffects.triggeredSkill,
                    triggeredCurse: itemEffects.triggeredCurse
                });
                
                profit = gameState.playerValuation - winningBid;
                wealthChange = profit;
                gameState.totalProfit += profit;
                gameState.streak++;
                success = true;
                
                gameState.stats.totalWins++;
                
                if (Math.abs(playerBid - calculateNashBid()) <= 5) {
                    gameState.stats.nashWinStreak++;
                } else {
                    gameState.stats.nashWinStreak = 0;
                }
                
                if (gameState.activeCurses.length >= 3) {
                    gameState.stats.cursedVictory = Math.max(gameState.stats.cursedVictory, gameState.activeCurses.length);
                }
                
                playSound('success');
                
                const rect = document.getElementById('auctionItem').getBoundingClientRect();
                createParticleEffect(
                    rect.left + rect.width / 2,
                    rect.top + rect.height / 2,
                    itemEffects.triggeredSkill ? 'skill' : (itemEffects.triggeredCurse ? 'curse' : 'success'),
                    25
                );
                
                showFloatingText(`财富+${profit}!`, "#2ea043");
                
            } else {
                profit = -gameState.marginFee;
                wealthChange = -gameState.marginFee;
                gameState.totalProfit += profit;
                gameState.streak = 0;
                gameState.stats.nashWinStreak = 0;
                
                if (profit < 0) {
                    gameState.stats.negativeProfitRounds++;
                }
                
                playSound('failure');
                
                const rect = document.getElementById('auctionItem').getBoundingClientRect();
                createParticleEffect(
                    rect.left + rect.width / 2,
                    rect.top + rect.height / 2,
                    'failure',
                    15
                );
                
                showFloatingText(`损失保证金: ${gameState.marginFee}`, "#f85149");
            }
            
            // AI处理
            aliveAIs.forEach(ai => {
                if (ai === winner && winner !== null && typeof winner === 'object') {
                    ai.totalWealth -= ai.bid;
                    ai.totalWealth += ai.valuation;
                    ai.wins++;
                    ai.lastAction = 'won';
                    ai.mood = 'confident';
                } else {
                    ai.lastAction = 'lost';
                    if (ai.mood === 'confident') {
                        ai.mood = 'neutral';
                    }
                }
                
                // AI疑虑增长
                if (success && isPlayerWinner) {
                    ai.suspicionLevel += 15 + Math.random() * 10;
                }
            });
            
            checkAchievements();
            checkEliminations();
            
            showResult(winner?.name || '未知', winningBid, playerBid, profit, success, wealthChange, itemEffects);
            updateRoundStats(playerBid, winningBid, winner?.name || '未知', wealthChange);
        }
        
        function showMarginNotice(fee) {
            const auctionItem = document.getElementById('auctionItem');
            const notice = document.createElement('div');
            notice.className = 'margin-notice';
            notice.innerHTML = `
                已支付入场费：${fee}<br>
                剩余财富: ${Math.floor(gameState.totalWealth)}
            `;
            
            auctionItem.style.position = 'relative';
            auctionItem.appendChild(notice);
            
            setTimeout(() => {
                notice.remove();
            }, 3000);
        }
        
        function checkEliminations() {
            let eliminatedThisRound = [];
            
            gameState.aiPlayers.forEach(ai => {
                if (!ai.eliminated && ai.totalWealth < gameState.marginFee) {
                    ai.eliminated = true;
                    eliminatedThisRound.push({
                        name: ai.name,
                        type: 'ai',
                        color: ai.color
                    });
                }
            });
            
            if (gameState.totalWealth < gameState.marginFee) {
                eliminatedThisRound.push({
                    name: '玩家',
                    type: 'player',
                    color: '#4a9eff'
                });
            }
            
            if (eliminatedThisRound.length > 0) {
                showEliminationAnimation(eliminatedThisRound);
            }
            
            return eliminatedThisRound;
        }
        
        function showEliminationAnimation(eliminated) {
            const overlay = document.getElementById('eliminationOverlay');
            const title = document.getElementById('eliminationTitle');
            const subtitle = document.getElementById('eliminationSubtitle');
            
            playSound('elimination');
            
            for (let i = 0; i < 40; i++) {
                setTimeout(() => {
                    createParticleEffect(
                        Math.random() * window.innerWidth,
                        Math.random() * window.innerHeight,
                        'elimination',
                        5
                    );
                }, i * 50);
            }
            
            if (eliminated.some(e => e.type === 'player')) {
                title.textContent = '灵魂消散';
                subtitle.textContent = '财富耗尽 - 被暗影吞噬';
            } else {
                const names = eliminated.map(e => e.name).join(', ');
                title.textContent = `${names}`;
                subtitle.textContent = '已被暗影吞噬';
            }
            
            overlay.classList.add('active');
        }
        
        function hideElimination() {
            playSound('click');
            document.getElementById('eliminationOverlay').classList.remove('active');
            
            if (gameState.totalWealth < gameState.marginFee) {
                setTimeout(() => {
                    const rankings = calculateFinalRankings();
                    gameOver(false, false);
                }, 500);
            } else {
                updateAIPlayersUI();
                updateUI();
            }
        }
        
        function showResult(winner, winningBid, playerBid, profit, success, wealthChange, itemEffects) {
            const panel = document.getElementById('resultPanel');
            const title = document.getElementById('resultTitle');
            const stats = document.getElementById('resultStats');
            const content = document.getElementById('resultContent');
            
            title.textContent = success ? '征服成功!' : '试炼失败';
            title.style.color = success ? "#2ea043" : "#f85149";
            
            stats.innerHTML = `
                <div class="result-stat">
                    <div class="result-stat-label">胜利者</div>
                    <div class="result-stat-value">${winner}</div>
                </div>
                <div class="result-stat">
                    <div class="result-stat-label">成交价</div>
                    <div class="result-stat-value">${winningBid}</div>
                </div>
                <div class="result-stat">
                    <div class="result-stat-label">你的出价</div>
                    <div class="result-stat-value">${playerBid}</div>
                </div>
                <div class="result-stat">
                    <div class="result-stat-label">财富变化</div>
                    <div class="result-stat-value" style="color: ${wealthChange >= 0 ? '#2ea043' : '#f85149'}">${wealthChange >= 0 ? '+' : ''}${wealthChange}</div>
                </div>
            `;
            
            const nashBid = calculateNashBid();
            const deviation = playerBid - nashBid;
            const itemsValue = gameState.wonItems.reduce((sum, item) => sum + item.valuation, 0);
            
            let specialEffectText = '';
            if (itemEffects.triggeredSkill) {
                specialEffectText += '<br><span style="color: #2ea043;">✨ 获得神秘力量!</span>';
            }
            if (itemEffects.triggeredCurse) {
                specialEffectText += '<br><span style="color: #8b4513;">💀 触发古老诅咒!</span>';
            }
            
            const mysteryText = gameState.currentItem && gameState.currentItem.mysteryLevel > gameState.mysteryUnlocked ? 
                '<br><span style="color: #9f7aea;">🔮 神秘面纱尚未揭开...</span>' : '';
            
            const analysis = `
                <div style="margin: 20px 0; padding: 15px; background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 8px;">
                    <div style="color: #ffd700; font-size: 10px; margin-bottom: 10px;">理性分析</div>
                    <div style="font-size: 8px; color: #c9d1d9;">
                        你的出价: ${playerBid} | 纳什出价: ${nashBid}<br>
                        偏差: <span style="color: ${Math.abs(deviation) <= 10 ? '#2ea043' : '#f85149'}">${deviation > 0 ? '+' : ''}${deviation}</span>
                        ${Math.abs(deviation) <= 10 ? ' 完美理性!' : ' 受情感影响'}<br>
                        <hr style="margin: 8px 0; border: none; border-top: 1px solid #30363d;">
                        总财富: <span style="color: #ffd700">${Math.floor(gameState.totalWealth)}</span> 
                        (现金: ${gameState.cash} + 藏品: ${Math.floor(itemsValue)})<br>
                        威胁等级: <span style="color: ${gameState.threatLevel === 'critical' ? '#f85149' : '#2ea043'}">${gameState.threatLevel.toUpperCase()}</span>
                        ${success ? `<br>获得估值: <span style="color: #2ea043">${gameState.playerValuation}</span>` : `<br>损失: <span style="color: #f85149">${Math.abs(profit)}</span>`}
                        ${specialEffectText}
                        ${mysteryText}
                    </div>
                </div>
                
                <div style="margin: 15px 0; padding: 15px; background: rgba(139, 69, 19, 0.1); border: 1px solid rgba(139, 69, 19, 0.3); border-radius: 8px;">
                    <div style="color: #8b4513; font-size: 10px; margin-bottom: 10px;">超自然状态</div>
                    <div style="font-size: 8px; color: #c9d1d9;">
                        神力: ${gameState.activeSkills.length > 0 ? gameState.activeSkills.map(s => s.name).join(', ') : '无'}<br>
                        诅咒: ${gameState.activeCurses.length > 0 ? gameState.activeCurses.map(c => c.name).join(', ') : '无'}<br>
                        已解锁神秘: ${gameState.mysteryUnlocked}/6<br>
                        阴谋等级: ${currentStoryState.conspiracyLevel}
                    </div>
                </div>
            `;
            
            content.innerHTML = analysis;
            panel.classList.add('active');
        }
        
        function nextRound() {
            playSound('click');
            gameState.level++;
            
            document.getElementById('resultPanel').classList.remove('active');
            updateUI();
            
            if (gameState.level > gameState.maxLevel) {
                setTimeout(() => {
                    const rankings = calculateFinalRankings();
                    const playerRank = rankings.findIndex(p => p.name === '玩家') + 1;
                    gameOver(playerRank === 1, false);
                }, 500);
            } else {
                startNewRound();
            }
        }

        function calculateFinalRankings() {
            const participants = [];
            
            participants.push({
                name: '玩家',
                totalWealth: gameState.totalWealth,
                isPlayer: true,
                eliminated: gameState.totalWealth < gameState.marginFee,
                finalScore: gameState.totalWealth + (gameState.mysteryUnlocked * 50)
            });
            
            gameState.aiPlayers.forEach(ai => {
                participants.push({
                    name: ai.name,
                    totalWealth: ai.totalWealth,
                    isPlayer: false,
                    eliminated: ai.eliminated,
                    strategy: ai.strategy,
                    color: ai.color,
                    finalScore: ai.totalWealth + (Math.random() * 100) // AI神秘加成
                });
            });
            
            return participants.sort((a, b) => b.finalScore - a.finalScore);
        }
        
        function gameOver(victory, lastSurvivor = false) {
            gameState.isGameOver = true;
            
            gameState.stats.gameTime = (Date.now() - gameState.stats.gameStartTime) / 1000;
            gameState.stats.gameCompleted = true;
            gameState.stats.lastSurvivor = lastSurvivor;
            
            const finalRankings = calculateFinalRankings();
            const playerRank = finalRankings.findIndex(p => p.name === '玩家') + 1;
            
            gameState.stats.finalRank = playerRank;
            gameState.stats.finalWealth = gameState.totalWealth;
            gameState.stats.perfectStrategy = gameState.stats.nashUsageRate >= 0.8 && gameState.stats.negativeProfitRounds === 0;
            
            if (gameState.totalWealth < gameState.marginFee * 3 && victory) {
                gameState.stats.comebackVictory = true;
            }
            
            checkAchievements();
            
            if (victory || playerRank === 1) {
                showVictoryScreen(finalRankings);
            } else {
                showDefeatScreen(finalRankings, playerRank);
            }
        }

        function showVictoryScreen(rankings) {
            const panel = document.getElementById('resultPanel');
            const title = document.getElementById('resultTitle');
            const stats = document.getElementById('resultStats');
            const content = document.getElementById('resultContent');
            
            title.textContent = '暗影征服者!';
            title.style.color = "#ffd700";
            
            const achievementCount = achievements.filter(a => a.unlocked).length;
            const itemsValue = gameState.wonItems.reduce((sum, item) => sum + item.valuation, 0);
            
            stats.innerHTML = `
                <div class="result-stat">
                    <div class="result-stat-label">最终排名</div>
                    <div class="result-stat-value" style="color: #ffd700;">暗影之王</div>
                </div>
                <div class="result-stat">
                    <div class="result-stat-label">财富总计</div>
                    <div class="result-stat-value">${Math.floor(gameState.totalWealth)}</div>
                </div>
                <div class="result-stat">
                    <div class="result-stat-label">传奇成就</div>
                    <div class="result-stat-value">${achievementCount}/15</div>
                </div>
                <div class="result-stat">
                    <div class="result-stat-label">试炼时长</div>
                    <div class="result-stat-value">${Math.floor(gameState.stats.gameTime / 60)}:${String(Math.floor(gameState.stats.gameTime % 60)).padStart(2, '0')}</div>
                </div>
            `;
            
            const rankingList = rankings.slice(0, 5).map((p, i) => {
                const prefix = p.name === '玩家' ? '👑 ' : '   ';
                const style = p.name === '玩家' ? 'color: #ffd700; font-weight: bold;' : '';
                return `${prefix}${i + 1}. ${p.name}: ${Math.floor(p.totalWealth)}`;
            }).join('<br>');
            
            const hayekPortrait = `
                    ╭─────────╮
                    │  ✨👑✨  │
                    │  哈耶克  │
                    │ 微笑点头 │
                    ╰─────────╯
            `;
            
            content.innerHTML = `
                <div style="font-size: 12px; margin: 20px 0; color: #ffd700; text-align: center;">
                    恭喜！你已成为暗影拍卖所的新主人！<br>
                    在超自然与理性的较量中获得了最终胜利！
                </div>
                
                <div style="margin: 20px 0; text-align: center;">
                    <pre style="font-size: 8px; color: #ffd700; line-height: 1.2; margin: 0;">${hayekPortrait}</pre>
                    <div style="font-size: 7px; color: #ffd700; margin-top: 5px;">
                        "哈耶克的灵魂终于可以安息了"
                    </div>
                </div>
                
                <div style="margin: 20px 0; padding: 15px; background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 8px;">
                    <div style="color: #ffd700; font-size: 10px; margin-bottom: 10px; text-align: center;">最终排行榜</div>
                    <div style="font-size: 8px; color: #c9d1d9; font-family: monospace; line-height: 1.6;">
                        ${rankingList}
                    </div>
                </div>
                
                <div style="margin: 15px 0; padding: 15px; background: rgba(13, 17, 23, 0.8); border: 2px solid #ffd700; border-radius: 10px; text-align: center;">
                    <div style="color: #ffd700; font-size: 9px; margin-bottom: 8px;">"你已经掌握了经济学的最高奥义，理性与疯狂的完美平衡。现在，这个暗影世界的一切都属于你了。"</div>
                    <div style="color: #9f7aea; font-size: 7px; font-style: italic;">
                        - 暗影拍卖所的最终启示
                    </div>
                </div>
                
                <div style="margin-top: 15px; text-align: center;">
                    <button class="pixel-btn" style="font-size: 8px;" onclick="showAchievements()">查看传奇</button>
                </div>
            `;
            
            playSound('level');
            
            // 胜利特效
            for (let i = 0; i < 60; i++) {
                setTimeout(() => {
                    createParticleEffect(
                        Math.random() * window.innerWidth,
                        Math.random() * window.innerHeight,
                        ['success', 'skill', 'mystery'][Math.floor(Math.random() * 3)],
                        5
                    );
                }, i * 100);
            }
            
            saveAchievements();
            panel.classList.add('active');
        }

        function showDefeatScreen(rankings, playerRank) {
            const panel = document.getElementById('resultPanel');
            const title = document.getElementById('resultTitle');
            const stats = document.getElementById('resultStats');
            const content = document.getElementById('resultContent');
            
            const defeatEndings = [
                {
                    title: "暗影吞噬",
                    subtitle: "理性的陨落",
                    quote: "我以为数学能拯救一切，却忘记了这里的规则早已被扭曲。",
                    advice: "在超自然面前，纯粹的理性有时是一种限制。",
                    color: "#8b4513"
                },
                {
                    title: "疯狂的代价",
                    subtitle: "拥抱黑暗的后果",
                    quote: "我获得了力量，却失去了自我。这就是与恶魔交易的代价。",
                    advice: "力量总是要付出代价的，确保你能承受它。",
                    color: "#f85149"
                },
                {
                    title: "未解之谜",
                    subtitle: "真相依然隐藏",
                    quote: "我距离真相如此接近，却在最后一步跌倒了。",
                    advice: "有些秘密需要更多的智慧和勇气才能揭开。",
                    color: "#9f7aea"
                }
            ];
            
            const ending = defeatEndings[Math.floor(Math.random() * defeatEndings.length)];
            
            title.textContent = ending.title;
            title.style.color = ending.color;
            
            const achievementCount = achievements.filter(a => a.unlocked).length;
            
            stats.innerHTML = `
                <div class="result-stat">
                    <div class="result-stat-label">最终排名</div>
                    <div class="result-stat-value" style="color: ${ending.color};">第${playerRank}名</div>
                </div>
                <div class="result-stat">
                    <div class="result-stat-label">财富总计</div>
                    <div class="result-stat-value">${Math.floor(gameState.totalWealth)}</div>
                </div>
                <div class="result-stat">
                    <div class="result-stat-label">传奇成就</div>
                    <div class="result-stat-value">${achievementCount}/15</div>
                </div>
                <div class="result-stat">
                    <div class="result-stat-label">到达轮次</div>
                    <div class="result-stat-value">${gameState.level}</div>
                </div>
            `;
            
            const rankingList = rankings.slice(0, Math.min(5, rankings.length)).map((p, i) => {
                const prefix = p.name === '玩家' ? '→ ' : '   ';
                const style = p.name === '玩家' ? 'color: #ffd700; font-weight: bold;' : '';
                return `${prefix}${i + 1}. ${p.name}: ${Math.floor(p.totalWealth)}`;
            }).join('<br>');
            
            const hayekPortrait = `
                    ╭─────────╮
                    │  😔💭📉  │
                    │  哈耶克  │
                    │ 失望摇头 │
                    ╰─────────╯
            `;
            
            content.innerHTML = `
                <div style="font-size: 12px; margin: 20px 0; color: ${ending.color}; text-align: center;">
                    ${ending.subtitle}
                </div>
                
                <div style="margin: 20px 0; text-align: center;">
                    <pre style="font-size: 8px; color: #7d8590; line-height: 1.2; margin: 0;">${hayekPortrait}</pre>
                    <div style="font-size: 7px; color: #7d8590; margin-top: 5px;">
                        "哈耶克的灵魂依然在等待着真正的继承者"
                    </div>
                </div>
                
                <div style="margin: 20px 0; padding: 15px; background: rgba(${ending.color.replace('#', '')}, 0.1); border: 1px solid rgba(${ending.color.replace('#', '')}, 0.3); border-radius: 8px;">
                    <div style="color: ${ending.color}; font-size: 10px; margin-bottom: 10px; text-align: center;">排行榜</div>
                    <div style="font-size: 8px; color: #c9d1d9; font-family: monospace; line-height: 1.6;">
                        ${rankingList}
                    </div>
                </div>
                
                <div style="margin: 15px 0; padding: 15px; background: rgba(13, 17, 23, 0.8); border: 2px solid #30363d; border-radius: 10px; text-align: center;">
                    <div style="color: ${ending.color}; font-size: 9px; margin-bottom: 8px;">"${ending.quote}"</div>
                    <div style="color: #7d8590; font-size: 7px; font-style: italic;">
                        ${ending.advice}
                    </div>
                </div>
                
                <div style="font-size: 8px; color: #7d8590; line-height: 1.6; text-align: center; margin-top: 15px;">
                    "在暗影中学到的每一课，都是通往真相的阶梯。"<br>
                    - 即使在失败中，智慧也在增长
                </div>
                
                <div style="margin-top: 15px; text-align: center;">
                    <button class="pixel-btn" style="font-size: 8px;" onclick="showAchievements()">查看成就</button>
                </div>
            `;
            
            playSound('failure');
            saveAchievements();
            panel.classList.add('active');
        }
        
        function updateRoundStats(playerBid, winningBid, winner, wealthChange) {
            const container = document.getElementById('roundStats');
            if (!container) return;
            
            const nashBid = calculateNashBid();
            const deviation = playerBid - nashBid;
            const deviationColor = Math.abs(deviation) <= 10 ? '#2ea043' : '#f85149';
            
            let aiInfo = '';
            gameState.aiPlayers.filter(ai => !ai.eliminated).forEach(ai => {
                const wealthColor = ai.totalWealth <= gameState.marginFee ? '#f85149' : '#c9d1d9';
                const suspicionColor = ai.suspicionLevel > 70 ? '#f85149' : '#7d8590';
                aiInfo += `${ai.name}: ${ai.bid} <span style="color: ${wealthColor}">(${Math.floor(ai.totalWealth)})</span> 
                          <span style="color: ${suspicionColor}; font-size: 6px;">[${Math.floor(ai.suspicionLevel)}%]</span><br>`;
            });
            
            const itemsValue = gameState.wonItems.reduce((sum, item) => sum + item.valuation, 0);
            
            container.innerHTML = `
                <div class="card">
                    <div class="card-title">拍卖分析</div>
                    <div class="card-content">
                        你的出价: ${playerBid}<br>
                        理性出价: ${nashBid}<br>
                        <span style="color: ${deviationColor}">偏差: ${deviation > 0 ? '+' : ''}${deviation}</span><br>
                        获胜者: ${winner}<br>
                        成交价: ${winningBid}<br>
                        财富变化: <span style="color: ${wealthChange >= 0 ? '#2ea043' : '#f85149'}">${wealthChange >= 0 ? '+' : ''}${wealthChange}</span><br>
                        威胁等级: <span style="color: ${gameState.threatLevel === 'critical' ? '#f85149' : '#2ea043'}">${gameState.threatLevel.toUpperCase()}</span>
                    </div>
                </div>
                <div class="card" style="margin-top: 15px;">
                    <div class="card-title">财富构成</div>
                    <div class="card-content" style="font-size: 7px;">
                        现金: <span style="color: ${gameState.cash <= gameState.marginFee ? '#f85149' : '#2ea043'}">${gameState.cash}</span><br>
                        藏品价值: <span style="color: #ffd700">${Math.floor(itemsValue)}</span><br>
                        总财富: <span style="color: #4a9eff">${Math.floor(gameState.totalWealth)}</span><br>
                        神秘解锁: ${gameState.mysteryUnlocked}/6
                    </div>
                </div>
                <div class="card" style="margin-top: 15px;">
                    <div class="card-title">竞争者情报</div>
                    <div class="card-content" style="font-size: 7px;">
                        ${aiInfo}
                    </div>
                </div>
            `;
        }

        // ===========================
        // 成就系统
        // ===========================
        
        function checkAchievements() {
            achievements.forEach(achievement => {
                if (!achievement.unlocked && achievement.condition(gameState.stats)) {
                    unlockAchievement(achievement);
                }
            });
        }

        function unlockAchievement(achievement) {
            achievement.unlocked = true;
            gameState.unlockedAchievements.push(achievement.id);
            
            showAchievementNotification(achievement);
            saveAchievements();
            playSound('level');
        }

        function showAchievementNotification(achievement) {
            const notification = document.getElementById('achievementNotification');
            const icon = document.getElementById('notificationIcon');
            const name = document.getElementById('notificationName');
            const quote = document.getElementById('notificationQuote');
            
            icon.textContent = achievement.icon;
            name.textContent = achievement.name;
            quote.textContent = achievement.quote;
            
            notification.style.display = 'block';
            notification.classList.add('show');
            
            for (let i = 0; i < 30; i++) {
                setTimeout(() => {
                    createParticleEffect(
                        window.innerWidth - 200,
                        100,
                        'success',
                        3
                    );
                }, i * 50);
            }
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 1000);
            }, 5000);
        }

        function showAchievements() {
            playSound('click');
            const panel = document.getElementById('achievementPanel');
            updateAchievementGrid();
            panel.classList.add('active');
        }

        function hideAchievements() {
            playSound('click');
            document.getElementById('achievementPanel').classList.remove('active');
        }

        function updateAchievementGrid() {
            const grid = document.getElementById('achievementGrid');
            if (!grid) return;
            
            grid.innerHTML = '';
            
            achievements.forEach(achievement => {
                const item = document.createElement('div');
                item.className = `achievement-item ${achievement.unlocked ? 'unlocked' : ''}`;
                
                item.innerHTML = `
                    <div class="achievement-item-header">
                        <div class="achievement-item-icon">${achievement.icon}</div>
                        <div class="achievement-item-name">${achievement.name}</div>
                    </div>
                    <div class="achievement-item-desc">${achievement.description}</div>
                    <div class="achievement-item-quote">${achievement.quote}</div>
                `;
                
                grid.appendChild(item);
            });
        }

        function saveAchievements() {
            try {
                const achievementData = {
                    unlocked: gameState.unlockedAchievements,
                    stats: gameState.stats
                };
                localStorage.setItem('shadow_auction_achievements', JSON.stringify(achievementData));
            } catch (e) {
                console.log('无法保存成就数据');
            }
        }

        function loadAchievements() {
            try {
                const data = localStorage.getItem('shadow_auction_achievements');
                if (data) {
                    const achievementData = JSON.parse(data);
                    gameState.unlockedAchievements = achievementData.unlocked || [];
                    gameState.stats = { ...gameState.stats, ...achievementData.stats };
                    
                    achievements.forEach(achievement => {
                        if (gameState.unlockedAchievements.includes(achievement.id)) {
                            achievement.unlocked = true;
                        }
                    });
                }
            } catch (e) {
                console.log('无法加载成就数据');
            }
        }

        // ===========================
        // 界面交互函数
        // ===========================
        
        function showTutorial() {
            playSound('click');
            document.getElementById('tutorialPanel').classList.add('active');
        }
        
        function hideTutorial() {
            playSound('click');
            document.getElementById('tutorialPanel').classList.remove('active');
        }

        function showLore() {
            playSound('mystery');
            document.getElementById('lorePanel').classList.add('active');
        }

        function hideLore() {
            playSound('click');
            document.getElementById('lorePanel').classList.remove('active');
        }
        
        function backToMenu() {
            playSound('click');
            gameState.isPlaying = false;
            document.getElementById('gameContainer').style.opacity = '0';
            document.getElementById('gameContainer').style.pointerEvents = 'none';
            document.getElementById('resultPanel').classList.remove('active');
            
            setTimeout(() => {
                document.getElementById('startScreen').classList.remove('hidden');
                document.getElementById('startScreen').style.opacity = '1';
                document.getElementById('startScreen').style.pointerEvents = 'all';
            }, 500);
        }
        
        function toggleFullscreen() {
            playSound('click');
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }
        
        // 键盘快捷键
        document.addEventListener('keydown', (e) => {
            if (!gameState.isPlaying) return;
            
            if (e.code === 'Escape') {
                e.preventDefault();
                backToMenu();
            }
            
            if (e.code === 'Space') {
                e.preventDefault();
                if (document.getElementById('resultPanel').classList.contains('active')) {
                    if (gameState.isGameOver) {
                        document.getElementById('resultPanel').classList.remove('active');
                        initGame();
                    } else {
                        nextRound();
                    }
                }
                
                if (document.getElementById('eliminationOverlay').classList.contains('active')) {
                    hideElimination();
                }
                
                if (document.getElementById('biddingRevealStage').classList.contains('active')) {
                    continueFromReveal();
                }
            }
            
            if (e.code === 'Enter') {
                e.preventDefault();
                if (!document.getElementById('biddingPanel').classList.contains('hidden')) {
                    submitBid();
                }
            }
            
            if (e.code === 'KeyN') {
                e.preventDefault();
                if (!document.getElementById('biddingPanel').classList.contains('hidden')) {
                    useNashStrategy();
                }
            }

            if (e.code === 'KeyI') {
                e.preventDefault();
                if (!document.getElementById('biddingPanel').classList.contains('hidden')) {
                    useIntuitiveStrategy();
                }
            }
        });
        
        // 防止右键菜单
        document.addEventListener('contextmenu', e => e.preventDefault());
        
        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            loadAchievements();
            
            try {
                new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
                console.log('Audio context not available');
            }
            
            console.log('%cTHE RATIONALIST\'S TRIAL - SHADOW AUCTION CHRONICLES', 'color: #ffd700; font-size: 16px; font-weight: bold;');
            console.log('%c踏入暗影，征服理性与疯狂的终极试炼！', 'color: #9f7aea; font-size: 12px;');
            
            // 输入验证
            ['initialWealth', 'aiCount', 'marginFee'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', function() {
                        const value = parseInt(this.value);
                        const min = parseInt(this.min);
                        const max = parseInt(this.max);
                        if (value < min) this.value = min;
                        if (value > max) this.value = max;
                    });
                }
            });
            
            // 自动更新暗影传言
            setInterval(() => {
                if (gameState.isPlaying) {
                    updateShadowRumors();
                }
            }, 10000);
        });
        
    </script>
</body>
</html>